# Next Session: Implementation Sprint - Critical Fixes
## Moving from Analysis to Action

**Date:** 2025-09-21 11:47  
**Previous Work:** Complete architecture analysis, gap identification, and roadmap to 10/10  
**Session Focus:** Implement critical infrastructure fixes

---

## ðŸŽ¯ Session Objectives

### Primary Goals
1. **Setup Azure VPN Gateway** - Enable Kali penetration testing access
2. **Implement Blue-Green Deployment** - Zero-downtime production deployments
3. **Create DB State Switching API** - Automated test data management
4. **Integrate DAST Scanning** - Runtime security validation

---

## ðŸ”§ Task 1: Azure VPN Gateway Setup

### Implementation Steps
```bash
# 1. Create VPN Gateway subnet
az network vnet subnet create \
  --resource-group secdevops-rg \
  --vnet-name vnet-secdevops \
  --name GatewaySubnet \
  --address-prefix 10.10.255.0/24

# 2. Create public IP for VPN
az network public-ip create \
  --resource-group secdevops-rg \
  --name vpn-gateway-ip \
  --allocation-method Dynamic

# 3. Create VPN Gateway (takes ~45 minutes)
az network vnet-gateway create \
  --resource-group secdevops-rg \
  --name vpn-secdevops \
  --public-ip-address vpn-gateway-ip \
  --vnet vnet-secdevops \
  --gateway-type Vpn \
  --vpn-type RouteBased \
  --sku VpnGw1 \
  --no-wait

# 4. Configure Point-to-Site for Kali
# Generate certificates
# Configure address pool: 172.16.0.0/24
# Download VPN client configuration
```

### Kali Configuration
```bash
# On Kali machine (192.168.1.100)
# 1. Install VPN client
sudo apt-get update
sudo apt-get install openvpn network-manager-openvpn

# 2. Import VPN configuration
# 3. Test connectivity to Test Environment
ping 10.40.1.10  # Should reach test environment
nmap -sn 10.40.1.0/24  # Network discovery test
```

---

## ðŸ”§ Task 2: Blue-Green Deployment Implementation

### Azure Infrastructure
```bash
# 1. Create Blue slot (current production)
az webapp deployment slot create \
  --name app-oversight-prod \
  --resource-group secdevops-rg \
  --slot blue

# 2. Create Green slot (new deployments)
az webapp deployment slot create \
  --name app-oversight-prod \
  --resource-group secdevops-rg \
  --slot green

# 3. Configure Application Gateway
az network application-gateway backend-pool create \
  --gateway-name appgw-secdevops \
  --resource-group secdevops-rg \
  --name blue-pool \
  --servers app-oversight-prod-blue.azurewebsites.net

az network application-gateway backend-pool create \
  --gateway-name appgw-secdevops \
  --resource-group secdevops-rg \
  --name green-pool \
  --servers app-oversight-prod-green.azurewebsites.net
```

### Deployment Scripts
```bash
# scripts/deploy-blue-green.sh
#!/bin/bash

ENVIRONMENT=$1  # blue or green
VERSION=$2

# Deploy to specified slot
echo "Deploying version $VERSION to $ENVIRONMENT slot..."
az webapp config container set \
  --name app-oversight-prod \
  --resource-group secdevops-rg \
  --slot $ENVIRONMENT \
  --docker-custom-image-name "acrsecdevopsdev.azurecr.io/oversight:$VERSION"

# Health check
./scripts/health-check.sh $ENVIRONMENT

# Traffic switch (if green deployment)
if [ "$ENVIRONMENT" = "green" ]; then
  ./scripts/switch-traffic.sh
fi
```

---

## ðŸ”§ Task 3: Database State Switching API

### API Implementation
```python
# api/test_data_manager.py
from flask import Flask, jsonify, request
import subprocess
import os

app = Flask(__name__)

DB_STATES = {
    'schema-only': '/sql/states/schema-only.sql',
    'framework': '/sql/states/framework-data.sql',
    'full': '/sql/states/full-test-data.sql'
}

current_state = 'schema-only'

@app.route('/api/test/db-state', methods=['GET'])
def get_db_state():
    return jsonify({'state': current_state})

@app.route('/api/test/db-state', methods=['POST'])
def switch_db_state():
    global current_state
    new_state = request.json.get('state')
    
    if new_state not in DB_STATES:
        return jsonify({'error': 'Invalid state'}), 400
    
    # Execute state switch
    sql_file = DB_STATES[new_state]
    result = subprocess.run([
        'psql',
        '-h', os.environ['DB_HOST'],
        '-U', os.environ['DB_USER'],
        '-d', os.environ['DB_NAME'],
        '-f', sql_file
    ], capture_output=True)
    
    if result.returncode == 0:
        previous_state = current_state
        current_state = new_state
        return jsonify({
            'success': True,
            'previousState': previous_state,
            'newState': new_state
        })
    else:
        return jsonify({'error': result.stderr.decode()}), 500

@app.route('/api/test/db-reset', methods=['POST'])
def reset_db():
    # Reset to current state (clean version)
    return switch_db_state()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

### Jenkins Integration
```groovy
// Jenkinsfile addition
stage('Setup Test Data') {
    steps {
        script {
            def testType = params.TEST_TYPE ?: 'integration'
            def dbState = testType == 'unit' ? 'schema-only' : 
                         testType == 'integration' ? 'framework' : 'full'
            
            // Switch database state via API
            sh """
                curl -X POST http://test-api:5000/api/test/db-state \
                  -H 'Content-Type: application/json' \
                  -d '{"state": "${dbState}"}'
            """
        }
    }
}
```

---

## ðŸ”§ Task 4: DAST Integration with OWASP ZAP

### ZAP Deployment
```yaml
# docker-compose.zap.yml
version: '3.8'
services:
  zap:
    image: owasp/zap2docker-stable
    container_name: owasp-zap
    ports:
      - "8080:8080"
      - "8090:8090"
    command: zap-webswing.sh
    volumes:
      - ./zap/reports:/zap/reports
      - ./zap/sessions:/zap/sessions
    networks:
      - secdevops-net

  zap-api:
    image: owasp/zap2docker-stable
    container_name: zap-api
    command: zap.sh -daemon -host 0.0.0.0 -port 8080 
            -config api.addrs.addr.name=.* 
            -config api.addrs.addr.regex=true 
            -config api.key=secdevops-api-key
    ports:
      - "8081:8080"
    networks:
      - secdevops-net
```

### Pipeline Integration
```groovy
// Jenkins DAST stage
stage('DAST Scanning') {
    when {
        expression { params.RUN_DAST == true }
    }
    steps {
        script {
            // Start ZAP daemon
            sh 'docker-compose -f docker-compose.zap.yml up -d zap-api'
            
            // Wait for ZAP to start
            sh 'sleep 30'
            
            // Run baseline scan
            sh """
                docker run --rm -v \$(pwd):/zap/wrk:rw \
                  --network secdevops-net \
                  owasp/zap2docker-stable zap-baseline.py \
                  -t http://app-test:8080 \
                  -r zap-report.html \
                  -J zap-report.json
            """
            
            // Analyze results
            def zapReport = readJSON file: 'zap-report.json'
            def highRiskAlerts = zapReport.site[0].alerts.findAll { 
                it.riskcode == '3' 
            }
            
            if (highRiskAlerts.size() > 0) {
                error "DAST scan found ${highRiskAlerts.size()} high-risk vulnerabilities"
            }
        }
    }
    post {
        always {
            // Archive reports
            archiveArtifacts artifacts: 'zap-report.*', allowEmptyArchive: true
            
            // Publish HTML report
            publishHTML([
                reportDir: '.',
                reportFiles: 'zap-report.html',
                reportName: 'ZAP Security Report'
            ])
        }
    }
}
```

---

## ðŸ“Š Quick Validation Tests

### Test VPN Connectivity
```bash
# From Kali machine after VPN setup
./test-vpn-connectivity.sh

#!/bin/bash
echo "Testing VPN connectivity to Azure..."
ping -c 4 10.40.1.10
nmap -p 80,443 10.40.1.10
curl http://10.40.1.10/health
```

### Test Blue-Green Deployment
```bash
# Deploy to green and switch
./deploy-blue-green.sh green v1.2.0
./test-green-health.sh
./switch-traffic.sh 10  # 10% traffic
./monitor-metrics.sh
./switch-traffic.sh 100  # Full switch
```

### Test DB State API
```bash
# Test state switching
curl http://localhost:5000/api/test/db-state
curl -X POST http://localhost:5000/api/test/db-state \
  -H 'Content-Type: application/json' \
  -d '{"state": "framework"}'
curl -X POST http://localhost:5000/api/test/db-reset
```

### Test DAST Scanning
```bash
# Run quick security scan
docker run --rm owasp/zap2docker-stable zap-baseline.py \
  -t http://test-app:8080 \
  -r test-scan.html
```

---

## ðŸ“ˆ Success Metrics

### Immediate Success Indicators
- [ ] Kali can reach test environment (10.40.1.0/24)
- [ ] Blue-green slots created and accessible
- [ ] DB state API responding on port 5000
- [ ] ZAP scan completes successfully

### Day 1 Completion Criteria
- [ ] VPN Gateway operational
- [ ] Penetration test from Kali successful
- [ ] Blue slot serving production traffic
- [ ] Green slot ready for deployments

### Week 1 Targets
- [ ] 3 successful blue-green deployments
- [ ] 5 automated rollbacks tested
- [ ] 100% DAST scan coverage
- [ ] DB state switches < 30 seconds

---

## ðŸš¨ Common Issues & Solutions

### VPN Gateway Issues
```bash
# If gateway creation fails
az network vnet-gateway show --name vpn-secdevops --resource-group secdevops-rg

# Check subnet configuration
az network vnet subnet show --resource-group secdevops-rg --vnet-name vnet-secdevops --name GatewaySubnet

# Regenerate certificates if connection fails
./scripts/regenerate-vpn-certs.sh
```

### Blue-Green Issues
```bash
# If slot swap fails
az webapp deployment slot swap --slot green --name app-oversight-prod --resource-group secdevops-rg --action preview

# Check slot configuration
az webapp deployment slot list --name app-oversight-prod --resource-group secdevops-rg

# Force traffic reset
az network application-gateway rule update --gateway-name appgw-secdevops --name rule1 --resource-group secdevops-rg --backend-pool blue-pool
```

### DB State API Issues
```python
# Add error handling
@app.errorhandler(500)
def handle_500(e):
    # Rollback to safe state
    switch_to_safe_state()
    return jsonify({'error': 'Database state switch failed', 'fallback': 'schema-only'}), 500
```

---

## ðŸ“ Documentation to Update

After implementation, update:
1. `NETWORK-CONFIGURATION-V7.md` - Add VPN Gateway details
2. `DEPLOYMENT-CHECKLIST-V7.md` - Add blue-green procedures
3. `JENKINS/Jenkinsfile` - Add DAST stage
4. `README.md` - Add new API endpoints

---

## âœ… Ready to Execute

**Start with:** VPN Gateway creation (45-minute process)
**While waiting:** Implement DB State API
**Then:** Setup blue-green slots
**Finally:** Integrate DAST scanning

**Estimated Time:** 
- Day 1: VPN + DB API
- Day 2: Blue-Green + DAST
- Day 3: Testing & validation

Use this guide to implement the critical fixes. Each task has clear steps, validation tests, and troubleshooting guidance.