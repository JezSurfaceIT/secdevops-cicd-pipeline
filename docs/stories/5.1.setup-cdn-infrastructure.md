# Story 5.1: Setup CDN Infrastructure

**Epic:** 5 - CBE Distribution  
**Story Number:** 5.1  
**Title:** Deploy Azure CDN with Global Edge Nodes  
**Status:** READY  
**Points:** 3  
**Component:** 531 (CDN)  

---

## Story

**As a** Platform Engineer,  
**I want** a global CDN for content delivery,  
**so that** users experience fast load times regardless of their geographic location.

---

## Acceptance Criteria

1. Azure CDN Premium deployed with Verizon provider
2. Custom domain with SSL configured
3. Origin groups configured for high availability
4. Caching rules optimized for different content types
5. Compression enabled for supported formats
6. Purge and preload capabilities implemented
7. Real-time analytics enabled
8. WAF integration at CDN edge

---

## Tasks / Subtasks

### Task 1: Write CDN Tests (TDD) (AC: 1, 2, 4)
- [ ] Create `distribution/cdn_test.go`
  - [ ] Test CDN deployment
  - [ ] Test SSL configuration
  - [ ] Test caching rules
  - [ ] Test content delivery
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Deploy CDN Infrastructure (AC: 1, 2)
- [ ] Create CDN profile and endpoints
  ```hcl
  resource "azurerm_cdn_profile" "main" {
    name                = "cdn-oversight-global"
    location            = "global"
    resource_group_name = azurerm_resource_group.cdn.name
    sku                 = "Premium_Verizon"
    
    tags = {
      environment = "production"
      component   = "cdn"
    }
  }
  
  resource "azurerm_cdn_endpoint" "app" {
    name                = "cdn-oversight-app"
    profile_name        = azurerm_cdn_profile.main.name
    location            = azurerm_cdn_profile.main.location
    resource_group_name = azurerm_resource_group.cdn.name
    
    origin_host_header = azurerm_app_service.main.default_site_hostname
    
    origin {
      name      = "app-origin"
      host_name = azurerm_app_service.main.default_site_hostname
      https_port = 443
      http_port  = 80
    }
    
    is_http_allowed  = false
    is_https_allowed = true
    
    content_types_to_compress = [
      "text/html",
      "text/css",
      "text/javascript",
      "text/plain",
      "application/javascript",
      "application/json",
      "application/xml",
      "image/svg+xml"
    ]
    
    is_compression_enabled = true
    
    global_delivery_rule {
      cache_expiration_action {
        behavior = "Override"
        duration = "7.00:00:00"
      }
      
      modify_response_header_action {
        action = "Append"
        name   = "X-CDN-Region"
        value  = "Global"
      }
    }
    
    delivery_rule {
      name  = "EnforceHTTPS"
      order = 1
      
      request_scheme_condition {
        operator     = "Equal"
        match_values = ["HTTP"]
      }
      
      url_redirect_action {
        redirect_type = "PermanentRedirect"
        protocol      = "Https"
      }
    }
    
    delivery_rule {
      name  = "CacheStaticContent"
      order = 2
      
      url_file_extension_condition {
        operator     = "Equal"
        match_values = ["jpg", "jpeg", "png", "gif", "webp", "ico", "svg"]
      }
      
      cache_expiration_action {
        behavior = "Override"
        duration = "30.00:00:00"
      }
    }
  }
  
  resource "azurerm_cdn_endpoint" "storage" {
    name                = "cdn-oversight-storage"
    profile_name        = azurerm_cdn_profile.main.name
    location            = azurerm_cdn_profile.main.location
    resource_group_name = azurerm_resource_group.cdn.name
    
    origin_host_header = azurerm_storage_account.static.primary_blob_host
    
    origin {
      name      = "storage-origin"
      host_name = azurerm_storage_account.static.primary_blob_host
    }
    
    optimization_type = "GeneralMediaStreaming"
    
    probe_path = "/health.txt"
  }
  ```
- [ ] Configure custom domain
  ```hcl
  resource "azurerm_cdn_endpoint_custom_domain" "app" {
    name            = "app-oversight-com"
    cdn_endpoint_id = azurerm_cdn_endpoint.app.id
    host_name       = "app.oversight.com"
    
    cdn_managed_https {
      certificate_type = "Dedicated"
      protocol_type    = "ServerNameIndication"
      tls_version      = "TLS12"
    }
  }
  
  resource "azurerm_dns_cname_record" "cdn_app" {
    name                = "app"
    zone_name           = azurerm_dns_zone.main.name
    resource_group_name = azurerm_resource_group.dns.name
    ttl                 = 3600
    record              = azurerm_cdn_endpoint.app.host_name
  }
  
  resource "azurerm_cdn_endpoint_custom_domain" "static" {
    name            = "static-oversight-com"
    cdn_endpoint_id = azurerm_cdn_endpoint.storage.id
    host_name       = "static.oversight.com"
    
    cdn_managed_https {
      certificate_type = "Dedicated"
      protocol_type    = "ServerNameIndication"
      tls_version      = "TLS12"
    }
  }
  ```
- [ ] Setup CDN validation
- [ ] Configure monitoring

### Task 3: Configure Origin Groups (AC: 3)
- [ ] Setup origin groups for HA
  ```hcl
  resource "azurerm_cdn_origin_group" "app" {
    name                     = "app-origin-group"
    cdn_endpoint_id          = azurerm_cdn_endpoint.app.id
    restore_traffic_time_to_healed_or_new_endpoint_in_minutes = 10
    
    health_probe {
      interval_in_seconds = 120
      path               = "/health"
      protocol           = "Https"
      probe_method       = "GET"
    }
    
    load_balancing {
      sample_size                     = 4
      successful_samples_required     = 3
      additional_latency_in_milliseconds = 50
    }
    
    origin {
      name       = "primary-app"
      host_name  = azurerm_app_service.primary.default_site_hostname
      http_port  = 80
      https_port = 443
      enabled    = true
      priority   = 1
      weight     = 1000
    }
    
    origin {
      name       = "secondary-app"
      host_name  = azurerm_app_service.secondary.default_site_hostname
      http_port  = 80
      https_port = 443
      enabled    = true
      priority   = 2
      weight     = 100
    }
  }
  
  resource "azurerm_cdn_origin_group" "storage" {
    name            = "storage-origin-group"
    cdn_endpoint_id = azurerm_cdn_endpoint.storage.id
    
    health_probe {
      interval_in_seconds = 60
      path               = "/health.txt"
      protocol           = "Https"
      probe_method       = "HEAD"
    }
    
    load_balancing {
      sample_size                  = 4
      successful_samples_required  = 2
    }
    
    origin {
      name       = "storage-east"
      host_name  = azurerm_storage_account.static_east.primary_blob_host
      enabled    = true
      priority   = 1
      weight     = 500
    }
    
    origin {
      name       = "storage-west"
      host_name  = azurerm_storage_account.static_west.primary_blob_host
      enabled    = true
      priority   = 1
      weight     = 500
    }
  }
  ```
- [ ] Configure health probes
- [ ] Setup failover logic
- [ ] Test origin switching

### Task 4: Optimize Caching Rules (AC: 4, 5)
- [ ] Configure caching policies
  ```javascript
  // config/cdn-rules.js
  const cdnRules = {
    // Static assets - long cache
    staticAssets: {
      patterns: ['/assets/*', '/images/*', '/fonts/*'],
      cache: {
        behavior: 'Override',
        duration: '365d',
        queryStringBehavior: 'Ignore'
      },
      headers: {
        'Cache-Control': 'public, max-age=31536000, immutable',
        'X-Content-Type-Options': 'nosniff'
      }
    },
    
    // CSS/JS with versioning
    versionedAssets: {
      patterns: ['*.css', '*.js'],
      cache: {
        behavior: 'Override',
        duration: '365d',
        queryStringBehavior: 'Include'
      },
      headers: {
        'Cache-Control': 'public, max-age=31536000',
        'Vary': 'Accept-Encoding'
      }
    },
    
    // API responses - short cache
    apiResponses: {
      patterns: ['/api/*'],
      cache: {
        behavior: 'Honor',
        queryStringBehavior: 'Include',
        methods: ['GET', 'HEAD']
      },
      headers: {
        'Cache-Control': 'public, max-age=60, must-revalidate',
        'Vary': 'Accept, Authorization'
      }
    },
    
    // Dynamic content - no cache
    dynamicContent: {
      patterns: ['/dashboard/*', '/account/*'],
      cache: {
        behavior: 'Bypass'
      },
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    },
    
    // Media streaming
    mediaStreaming: {
      patterns: ['*.mp4', '*.webm', '*.m3u8'],
      cache: {
        behavior: 'Override',
        duration: '7d',
        enableRangeRequests: true
      },
      optimization: 'VideoOnDemand'
    }
  };
  
  module.exports = cdnRules;
  ```
- [ ] Setup compression rules
  ```hcl
  resource "azurerm_cdn_endpoint_delivery_rule" "compression" {
    name            = "compression-rule"
    cdn_endpoint_id = azurerm_cdn_endpoint.app.id
    order          = 3
    
    conditions {
      request_header {
        selector = "Accept-Encoding"
        operator = "Contains"
        match_values = ["gzip", "br"]
      }
    }
    
    actions {
      modify_response_header {
        action = "Overwrite"
        name   = "Content-Encoding"
        value  = "gzip"
      }
    }
  }
  ```
- [ ] Configure query string handling
- [ ] Test caching effectiveness

### Task 5: Implement Purge and Preload (AC: 6)
- [ ] Create purge service
  ```javascript
  // services/cdn-manager.js
  const { CdnManagementClient } = require('@azure/arm-cdn');
  const { DefaultAzureCredential } = require('@azure/identity');
  
  class CDNManager {
    constructor() {
      this.credential = new DefaultAzureCredential();
      this.client = new CdnManagementClient(
        this.credential,
        process.env.AZURE_SUBSCRIPTION_ID
      );
      this.resourceGroup = process.env.CDN_RESOURCE_GROUP;
      this.profileName = process.env.CDN_PROFILE_NAME;
    }
    
    async purgeContent(endpointName, paths) {
      console.log(`Purging CDN content for ${endpointName}: ${paths.join(', ')}`);
      
      try {
        const result = await this.client.endpoints.purgeContent(
          this.resourceGroup,
          this.profileName,
          endpointName,
          {
            contentPaths: paths
          }
        );
        
        // Track purge operation
        await this.trackOperation('purge', {
          endpoint: endpointName,
          paths,
          timestamp: new Date(),
          operationId: result.name
        });
        
        return result;
      } catch (error) {
        console.error('CDN purge failed:', error);
        throw error;
      }
    }
    
    async preloadContent(endpointName, paths) {
      console.log(`Preloading CDN content for ${endpointName}: ${paths.join(', ')}`);
      
      try {
        const result = await this.client.endpoints.loadContent(
          this.resourceGroup,
          this.profileName,
          endpointName,
          {
            contentPaths: paths
          }
        );
        
        // Track preload operation
        await this.trackOperation('preload', {
          endpoint: endpointName,
          paths,
          timestamp: new Date(),
          operationId: result.name
        });
        
        return result;
      } catch (error) {
        console.error('CDN preload failed:', error);
        throw error;
      }
    }
    
    async invalidateCache(patterns) {
      const endpoints = ['app', 'storage'];
      const operations = [];
      
      for (const endpoint of endpoints) {
        const paths = this.expandPatterns(patterns);
        operations.push(this.purgeContent(endpoint, paths));
      }
      
      await Promise.all(operations);
      
      // Optionally preload critical paths
      const criticalPaths = ['/index.html', '/app.js', '/app.css'];
      await this.preloadContent('app', criticalPaths);
    }
    
    expandPatterns(patterns) {
      const paths = [];
      
      for (const pattern of patterns) {
        if (pattern.includes('*')) {
          // Expand wildcard patterns
          paths.push(pattern);
        } else {
          paths.push(pattern);
          // Add common variations
          if (!pattern.endsWith('/')) {
            paths.push(pattern + '/');
          }
          paths.push(pattern + '/index.html');
        }
      }
      
      return [...new Set(paths)]; // Remove duplicates
    }
    
    async warmCache() {
      const criticalAssets = [
        '/index.html',
        '/manifest.json',
        '/service-worker.js',
        '/assets/app.css',
        '/assets/app.js',
        '/images/logo.svg',
        '/api/config'
      ];
      
      console.log('Warming CDN cache with critical assets...');
      await this.preloadContent('app', criticalAssets);
      
      // Warm storage CDN
      const storageAssets = [
        '/images/hero-banner.jpg',
        '/videos/intro.mp4',
        '/documents/terms.pdf'
      ];
      
      await this.preloadContent('storage', storageAssets);
    }
    
    async getOperationStatus(operationId) {
      // Check operation status
      const operation = await this.client.operations.get(operationId);
      return {
        id: operation.name,
        status: operation.status,
        progress: operation.percentComplete,
        error: operation.error
      };
    }
  }
  
  module.exports = new CDNManager();
  ```
- [ ] Setup cache warming
- [ ] Configure automated purge
- [ ] Test purge/preload

### Task 6: Enable Real-time Analytics (AC: 7)
- [ ] Configure CDN analytics
  ```hcl
  resource "azurerm_cdn_endpoint_diagnostic" "app" {
    cdn_endpoint_id = azurerm_cdn_endpoint.app.id
    
    log_analytics_workspace_id = azurerm_log_analytics_workspace.main.id
    
    log {
      category = "AzureCdnAccessLog"
      enabled  = true
      
      retention_policy {
        enabled = true
        days    = 30
      }
    }
  }
  
  resource "azurerm_monitor_diagnostic_setting" "cdn" {
    name               = "cdn-diagnostics"
    target_resource_id = azurerm_cdn_profile.main.id
    
    log_analytics_workspace_id = azurerm_log_analytics_workspace.main.id
    storage_account_id        = azurerm_storage_account.logs.id
    
    metric {
      category = "AllMetrics"
      
      retention_policy {
        enabled = true
        days    = 30
      }
    }
  }
  ```
- [ ] Create analytics dashboard
  ```javascript
  // services/cdn-analytics.js
  class CDNAnalytics {
    constructor() {
      this.workspace = process.env.LOG_ANALYTICS_WORKSPACE_ID;
    }
    
    async getPerformanceMetrics(timeRange = '1h') {
      const query = `
        AzureDiagnostics
        | where ResourceType == "CDNENDPOINTS"
        | where TimeGenerated > ago(${timeRange})
        | summarize 
            RequestCount = count(),
            CacheHitRatio = avg(cacheHit_b),
            AvgLatency = avg(timeTaken_d),
            BytesServed = sum(responseSize_d),
            UniqueClients = dcount(clientIp_s)
          by bin(TimeGenerated, 5m), endpoint_s
        | order by TimeGenerated desc
      `;
      
      return await this.executeQuery(query);
    }
    
    async getTopContent(limit = 20) {
      const query = `
        AzureDiagnostics
        | where ResourceType == "CDNENDPOINTS"
        | where TimeGenerated > ago(24h)
        | summarize 
            Requests = count(),
            UniqueUsers = dcount(clientIp_s),
            TotalBytes = sum(responseSize_d),
            AvgLatency = avg(timeTaken_d)
          by requestUri_s
        | top ${limit} by Requests desc
      `;
      
      return await this.executeQuery(query);
    }
    
    async getGeographicDistribution() {
      const query = `
        AzureDiagnostics
        | where ResourceType == "CDNENDPOINTS"
        | where TimeGenerated > ago(24h)
        | extend Country = geo_info_from_ip_address(clientIp_s).country
        | summarize 
            Requests = count(),
            UniqueUsers = dcount(clientIp_s),
            AvgLatency = avg(timeTaken_d)
          by Country
        | order by Requests desc
      `;
      
      return await this.executeQuery(query);
    }
    
    async getCacheEfficiency() {
      const query = `
        AzureDiagnostics
        | where ResourceType == "CDNENDPOINTS"
        | where TimeGenerated > ago(1h)
        | extend CacheStatus = iff(cacheHit_b == true, "Hit", "Miss")
        | summarize 
            Count = count()
          by CacheStatus, bin(TimeGenerated, 5m)
        | evaluate pivot(CacheStatus, sum(Count))
        | extend HitRatio = Hit / (Hit + Miss) * 100
        | project TimeGenerated, Hit, Miss, HitRatio
      `;
      
      return await this.executeQuery(query);
    }
    
    async getErrorAnalysis() {
      const query = `
        AzureDiagnostics
        | where ResourceType == "CDNENDPOINTS"
        | where TimeGenerated > ago(1h)
        | where httpStatusCode_d >= 400
        | summarize 
            ErrorCount = count()
          by httpStatusCode_d, requestUri_s, bin(TimeGenerated, 5m)
        | order by ErrorCount desc
      `;
      
      return await this.executeQuery(query);
    }
    
    async getBandwidthUsage() {
      const query = `
        AzureDiagnostics
        | where ResourceType == "CDNENDPOINTS"
        | where TimeGenerated > ago(24h)
        | summarize 
            TotalBytes = sum(responseSize_d),
            IngressBytes = sum(requestSize_d),
            EgressBytes = sum(responseSize_d)
          by bin(TimeGenerated, 1h), endpoint_s
        | extend 
            TotalGB = TotalBytes / 1024 / 1024 / 1024,
            EgressGB = EgressBytes / 1024 / 1024 / 1024
        | project TimeGenerated, endpoint_s, TotalGB, EgressGB
      `;
      
      return await this.executeQuery(query);
    }
  }
  ```
- [ ] Setup alerting
- [ ] Create reports

### Task 7: Integrate WAF at Edge (AC: 8)
- [ ] Configure WAF rules
  ```hcl
  resource "azurerm_cdn_security_policy" "waf" {
    name            = "waf-policy"
    cdn_endpoint_id = azurerm_cdn_endpoint.app.id
    
    parameters {
      type = "WebApplicationFirewall"
      
      waf_policy {
        cdn_frontdoor_firewall_policy_id = azurerm_cdn_frontdoor_firewall_policy.main.id
      }
      
      association {
        domain {
          cdn_frontdoor_domain_id = azurerm_cdn_endpoint_custom_domain.app.id
        }
        
        patterns_to_match = ["/*"]
      }
    }
  }
  
  resource "azurerm_cdn_frontdoor_firewall_policy" "main" {
    name                              = "wafpolicy"
    resource_group_name              = azurerm_resource_group.cdn.name
    sku_name                         = "Premium_AzureFrontDoor"
    enabled                          = true
    mode                             = "Prevention"
    custom_block_response_status_code = 403
    custom_block_response_body       = base64encode("Access Denied")
    
    custom_rule {
      name                           = "RateLimitRule"
      enabled                        = true
      priority                       = 1
      rate_limit_duration_in_minutes = 1
      rate_limit_threshold          = 100
      type                          = "RateLimiting"
      action                        = "Block"
      
      match_condition {
        match_variable     = "RequestUri"
        operator           = "Contains"
        match_values       = ["/api/"]
      }
    }
    
    custom_rule {
      name     = "BlockSuspiciousAgents"
      enabled  = true
      priority = 2
      type     = "MatchRule"
      action   = "Block"
      
      match_condition {
        match_variable     = "RequestHeader"
        selector          = "User-Agent"
        operator          = "Contains"
        match_values      = ["bot", "crawler", "scanner"]
        transforms        = ["Lowercase"]
      }
    }
    
    managed_rule {
      type    = "DefaultRuleSet"
      version = "1.0"
      
      exclusion {
        match_variable = "RequestHeaderNames"
        operator       = "Equals"
        selector       = "x-api-key"
      }
      
      override {
        rule_group {
          rule_group_name = "SQLI"
          
          rule {
            rule_id = "942100"
            enabled = false
          }
        }
      }
    }
    
    managed_rule {
      type    = "BotProtection"
      version = "1.0"
    }
  }
  ```
- [ ] Setup DDoS protection
- [ ] Configure rate limiting
- [ ] Test WAF rules

### Task 8: Implement CDN Monitoring (AC: 1, 7)
- [ ] Create monitoring dashboard
  ```javascript
  // monitoring/cdn-monitor.js
  class CDNMonitor {
    constructor() {
      this.thresholds = {
        cacheHitRatio: 0.8,
        latency: 100,
        errorRate: 0.01,
        availability: 0.999
      };
    }
    
    async checkHealth() {
      const metrics = {
        cacheHitRatio: await this.getCacheHitRatio(),
        latency: await this.getAverageLatency(),
        errorRate: await this.getErrorRate(),
        availability: await this.getAvailability()
      };
      
      const issues = [];
      
      if (metrics.cacheHitRatio < this.thresholds.cacheHitRatio) {
        issues.push({
          type: 'warning',
          message: `Low cache hit ratio: ${metrics.cacheHitRatio}`,
          action: 'Review caching rules and content headers'
        });
      }
      
      if (metrics.latency > this.thresholds.latency) {
        issues.push({
          type: 'warning',
          message: `High latency: ${metrics.latency}ms`,
          action: 'Check origin server performance'
        });
      }
      
      if (metrics.errorRate > this.thresholds.errorRate) {
        issues.push({
          type: 'critical',
          message: `High error rate: ${metrics.errorRate * 100}%`,
          action: 'Investigate error logs immediately'
        });
      }
      
      if (metrics.availability < this.thresholds.availability) {
        issues.push({
          type: 'critical',
          message: `Low availability: ${metrics.availability * 100}%`,
          action: 'Check endpoint health and origin servers'
        });
      }
      
      return { metrics, issues };
    }
    
    async generateReport() {
      const report = {
        generated: new Date(),
        performance: await this.getPerformanceReport(),
        usage: await this.getUsageReport(),
        security: await this.getSecurityReport(),
        recommendations: await this.getRecommendations()
      };
      
      return report;
    }
  }
  ```
- [ ] Setup alerts
- [ ] Configure SLA monitoring
- [ ] Create performance reports

---

## Dev Notes

### CDN Endpoints
```
App: https://app.oversight.com (cdn-oversight-app.azureedge.net)
Static: https://static.oversight.com (cdn-oversight-storage.azureedge.net)
API: https://api.oversight.com (cdn-oversight-api.azureedge.net)
```

### Cache Headers
```
Static: Cache-Control: public, max-age=31536000, immutable
Dynamic: Cache-Control: no-cache, no-store, must-revalidate
API: Cache-Control: public, max-age=60, must-revalidate
```

### Purge Patterns
```
All: /*
Images: /images/*
Scripts: /assets/*.js
Styles: /assets/*.css
API: /api/*
```

### Performance Targets
- Cache Hit Ratio: > 80%
- Average Latency: < 100ms
- Availability: > 99.9%
- Bandwidth Cost: < $5000/month

### Testing Standards
- Test location: `/tests/distribution/cdn/`
- Test cache effectiveness
- Verify SSL configuration
- Test purge functionality
- Monitor bandwidth usage

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_