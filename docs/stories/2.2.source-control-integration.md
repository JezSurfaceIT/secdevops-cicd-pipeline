# Story 2.2: Configure Source Control Integration

**Epic:** 2 - CI/CD Pipeline Foundation  
**Story Number:** 2.2  
**Title:** Setup GitHub Webhooks and Branch Protection  
**Status:** READY  
**Points:** 3  
**Component:** 201 (GitHub Main Repo)  

---

## Story

**As a** Lead Developer,  
**I want** GitHub integrated with Jenkins with proper branch protection,  
**so that** code changes automatically trigger secure CI/CD pipelines.

---

## Acceptance Criteria

1. GitHub webhooks configured to trigger Jenkins builds
2. Webhook payload validated with secret token
3. Branch protection rules enforced on main branch
4. Pull request checks required before merge
5. Signed commits required for production branches
6. Jenkins GitHub plugin configured with proper credentials
7. Build status reported back to GitHub
8. All webhook traffic goes through IP allowlist

---

## Tasks / Subtasks

### Task 1: Write Integration Tests (TDD) (AC: 1, 7)
- [ ] Create `integration/github_webhook_test.go`
  - [ ] Test webhook triggers build
  - [ ] Test invalid webhook rejected
  - [ ] Test build status updates PR
  - [ ] Test branch protection blocks direct push
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Configure GitHub Webhooks (AC: 1, 2, 8)
- [ ] Generate webhook secret token
  ```bash
  openssl rand -hex 32 > webhook-secret.txt
  ```
- [ ] Add webhook in GitHub repository settings
  - [ ] URL: https://172.178.53.198/github-webhook/
  - [ ] Content type: application/json
  - [ ] Secret: Generated token
  - [ ] Events: Push, Pull Request, Release
- [ ] Configure SSL verification
- [ ] Test webhook connectivity

### Task 3: Setup Jenkins GitHub Integration (AC: 6)
- [ ] Install GitHub plugins
  ```groovy
  plugins {
    'github': '1.34.5',
    'github-branch-source': '2.11.5',
    'github-pullrequest': '0.4.0'
  }
  ```
- [ ] Configure GitHub server in Jenkins
  - [ ] Add GitHub App or OAuth credentials
  - [ ] Configure API endpoint
  - [ ] Set up webhook validation
- [ ] Create GitHub credential in Jenkins
  - [ ] Personal Access Token or GitHub App
  - [ ] Scope: repo, admin:repo_hook

### Task 4: Implement Branch Protection (AC: 3, 4, 5)
- [ ] Configure main branch protection
  ```yaml
  protection_rules:
    - branch: main
      required_reviews: 2
      dismiss_stale_reviews: true
      require_code_owner_reviews: true
      required_status_checks:
        - "jenkins/build"
        - "jenkins/test"
        - "security/scan"
      enforce_admins: true
      require_signed_commits: true
  ```
- [ ] Setup CODEOWNERS file
  ```
  # Global owners
  * @devops-team
  
  # Terraform owners
  /terraform/ @infrastructure-team
  
  # Security configs
  /security/ @security-team
  ```
- [ ] Configure commit signing
  - [ ] Document GPG setup for developers
  - [ ] Enforce on production branches

### Task 5: Create Jenkins Pipeline Jobs (AC: 7)
- [ ] Create Multibranch Pipeline job
  ```groovy
  multibranchPipelineJob('oversight-mvp') {
    branchSources {
      github {
        id('github')
        repoOwner('your-org')
        repository('oversight-mvp')
        credentialsId('github-credentials')
        traits {
          gitHubBranchDiscovery {
            strategyId(1) // Exclude branches that are also PRs
          }
          gitHubPullRequestDiscovery {
            strategyId(1)
          }
        }
      }
    }
    
    orphanedItemStrategy {
      discardOldItems {
        numToKeep(20)
        daysToKeep(30)
      }
    }
  }
  ```
- [ ] Configure build triggers
- [ ] Set up post-build actions

### Task 6: Implement Status Reporting (AC: 7)
- [ ] Configure Jenkins to update GitHub status
  ```groovy
  pipeline {
    post {
      always {
        script {
          def status = currentBuild.result ?: 'SUCCESS'
          githubNotify(
            context: 'jenkins/build',
            description: "Build ${status.toLowerCase()}",
            status: status,
            targetUrl: "${BUILD_URL}"
          )
        }
      }
    }
  }
  ```
- [ ] Add status badges to README
- [ ] Configure PR comment updates

### Task 7: Secure Webhook Endpoint (AC: 2, 8)
- [ ] Validate webhook signatures
  ```groovy
  def validateWebhook(payload, signature) {
    def secret = credentials('github-webhook-secret')
    def hmac = hmacSha256(secret, payload)
    return hmac == signature
  }
  ```
- [ ] Ensure webhook only accessible through App Gateway
- [ ] Add rate limiting for webhook endpoint
- [ ] Log all webhook activity

---

## Dev Notes

### GitHub Webhook Configuration
```json
{
  "name": "web",
  "active": true,
  "events": [
    "push",
    "pull_request",
    "release",
    "deployment",
    "deployment_status"
  ],
  "config": {
    "url": "https://172.178.53.198/github-webhook/",
    "content_type": "json",
    "secret": "${WEBHOOK_SECRET}",
    "insecure_ssl": "0"
  }
}
```

### Jenkins Pipeline for GitHub
```groovy
pipeline {
  agent any
  
  options {
    buildDiscarder(logRotator(numToKeepStr: '10'))
    timestamps()
  }
  
  triggers {
    githubPush()
    githubPullRequests()
  }
  
  stages {
    stage('Validate') {
      steps {
        script {
          if (env.CHANGE_ID) {
            echo "Pull Request: ${env.CHANGE_ID}"
            echo "Source Branch: ${env.CHANGE_BRANCH}"
            echo "Target Branch: ${env.CHANGE_TARGET}"
          }
        }
      }
    }
    
    stage('Build') {
      steps {
        sh 'make build'
      }
    }
    
    stage('Test') {
      steps {
        sh 'make test'
      }
    }
    
    stage('Security Scan') {
      steps {
        sh 'make security-scan'
      }
    }
  }
  
  post {
    success {
      githubNotify(
        context: 'jenkins/build',
        description: 'Build successful',
        status: 'SUCCESS'
      )
    }
    failure {
      githubNotify(
        context: 'jenkins/build',
        description: 'Build failed',
        status: 'FAILURE'
      )
    }
  }
}
```

### Branch Protection API Script
```bash
#!/bin/bash
# setup-branch-protection.sh

REPO="your-org/oversight-mvp"
BRANCH="main"
TOKEN="${GITHUB_TOKEN}"

curl -X PUT \
  -H "Authorization: token ${TOKEN}" \
  -H "Accept: application/vnd.github.v3+json" \
  "https://api.github.com/repos/${REPO}/branches/${BRANCH}/protection" \
  -d '{
    "required_status_checks": {
      "strict": true,
      "contexts": ["jenkins/build", "jenkins/test", "security/scan"]
    },
    "enforce_admins": true,
    "required_pull_request_reviews": {
      "required_approving_review_count": 2,
      "dismiss_stale_reviews": true,
      "require_code_owner_reviews": true
    },
    "restrictions": null,
    "required_linear_history": false,
    "allow_force_pushes": false,
    "allow_deletions": false,
    "required_conversation_resolution": true
  }'
```

### Testing Standards
- Test location: `/tests/integration/`
- Mock GitHub webhook payloads
- Validate signature verification
- Test branch protection rules
- Verify status updates work

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_