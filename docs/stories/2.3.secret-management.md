# Story 2.3: Implement Secret Management

**Epic:** 2 - CI/CD Pipeline Foundation  
**Story Number:** 2.3  
**Title:** Deploy HashiCorp Vault for Secrets  
**Status:** READY  
**Points:** 5  
**Components:** 303 (Test Vault), 305 (CBE Vault)  

---

## Story

**As a** Security Engineer,  
**I want** centralized secret management using HashiCorp Vault,  
**so that** sensitive data is never stored in code or configuration files.

---

## Acceptance Criteria

1. HashiCorp Vault deployed for test environment (10.40.2.10)
2. Separate Vault instance for CBE environment (10.80.2.10)
3. Auto-unseal configured using Azure Key Vault
4. Authentication configured for Jenkins and applications
5. Secret engines enabled (KV v2, Database, PKI)
6. Audit logging enabled and sent to Log Analytics
7. Backup and recovery procedures documented
8. All secrets migrated from environment files

---

## Tasks / Subtasks

### Task 1: Write Infrastructure Tests (TDD) (AC: 1, 2)
- [ ] Create `security/vault_test.go`
  - [ ] Test Vault deployment successful
  - [ ] Test auto-unseal works
  - [ ] Test authentication methods
  - [ ] Test secret engines enabled
  - [ ] Test audit logging configured
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Deploy Test Vault Instance (AC: 1, 3)
- [ ] Create Terraform module for Vault
  ```hcl
  resource "azurerm_container_instance" "vault_test" {
    name                = "aci-vault-test"
    location            = var.location
    resource_group_name = var.resource_group_name
    ip_address_type     = "Private"
    subnet_id          = var.subnet_id
    os_type            = "Linux"
    
    container {
      name   = "vault"
      image  = "hashicorp/vault:1.15"
      cpu    = "1"
      memory = "2"
      
      ports {
        port     = 8200
        protocol = "TCP"
      }
      
      environment_variables = {
        VAULT_ADDR = "http://0.0.0.0:8200"
        VAULT_API_ADDR = "http://10.40.2.10:8200"
      }
      
      volume {
        name       = "vault-config"
        mount_path = "/vault/config"
        read_only  = false
        secret = {
          "config.hcl" = base64encode(local.vault_config)
        }
      }
    }
  }
  ```
- [ ] Configure storage backend (Azure Storage)
- [ ] Setup TLS certificates
- [ ] Configure network access

### Task 3: Configure Auto-Unseal (AC: 3)
- [ ] Create Azure Key Vault for unseal keys
  ```hcl
  resource "azurerm_key_vault_key" "vault_unseal" {
    name         = "vault-unseal-key"
    key_vault_id = azurerm_key_vault.main.id
    key_type     = "RSA"
    key_size     = 2048
    
    key_opts = [
      "decrypt",
      "encrypt",
      "sign",
      "unwrapKey",
      "verify",
      "wrapKey"
    ]
  }
  ```
- [ ] Configure Vault auto-unseal
  ```hcl
  seal "azurekeyvault" {
    tenant_id     = var.tenant_id
    client_id     = var.client_id
    client_secret = var.client_secret
    vault_name    = var.key_vault_name
    key_name      = var.unseal_key_name
  }
  ```
- [ ] Test auto-unseal on restart
- [ ] Document unseal process

### Task 4: Setup Authentication Methods (AC: 4)
- [ ] Configure AppRole for Jenkins
  ```bash
  vault auth enable approle
  vault write auth/approle/role/jenkins \
    token_policies="jenkins-policy" \
    token_ttl=1h \
    token_max_ttl=4h
  ```
- [ ] Configure Azure Auth for applications
  ```bash
  vault auth enable azure
  vault write auth/azure/config \
    tenant_id="${TENANT_ID}" \
    resource="https://management.azure.com/" \
    client_id="${CLIENT_ID}" \
    client_secret="${CLIENT_SECRET}"
  ```
- [ ] Create service account tokens
- [ ] Configure LDAP/AD if needed

### Task 5: Enable Secret Engines (AC: 5)
- [ ] Enable KV v2 secrets engine
  ```bash
  vault secrets enable -path=secret kv-v2
  
  # Create secret paths
  vault kv put secret/test/database \
    username="dbuser" \
    password="$(openssl rand -base64 32)"
    
  vault kv put secret/test/api \
    key="$(uuidgen)" \
    secret="$(openssl rand -base64 32)"
  ```
- [ ] Enable database secrets engine
  ```bash
  vault secrets enable database
  
  vault write database/config/postgresql \
    plugin_name=postgresql-database-plugin \
    connection_url="postgresql://{{username}}:{{password}}@10.40.2.20:5432/testdb" \
    allowed_roles="readonly,readwrite" \
    username="vault" \
    password="vaultpass"
  ```
- [ ] Enable PKI for certificate management
- [ ] Configure AWS/Azure secret engines if needed

### Task 6: Configure Audit Logging (AC: 6)
- [ ] Enable file audit backend
  ```bash
  vault audit enable file \
    file_path=/vault/logs/audit.log \
    log_raw=true
  ```
- [ ] Configure syslog forwarding
  ```bash
  vault audit enable syslog \
    tag="vault" \
    facility="LOCAL7"
  ```
- [ ] Setup log shipping to Azure Log Analytics
- [ ] Create audit log retention policy
- [ ] Test audit trail completeness

### Task 7: Deploy CBE Vault Instance (AC: 2)
- [ ] Replicate configuration for CBE environment
  - [ ] IP: 10.80.2.10
  - [ ] Separate storage backend
  - [ ] Different unseal key
- [ ] Configure CBE-specific secrets
- [ ] Setup replication if needed
- [ ] Document differences from test Vault

### Task 8: Migrate Existing Secrets (AC: 8)
- [ ] Inventory all existing secrets
  ```bash
  # Scan for secrets in config files
  grep -r "password\|secret\|key\|token" --include="*.env" .
  ```
- [ ] Create migration script
  ```bash
  #!/bin/bash
  # migrate-secrets.sh
  
  # Database passwords
  vault kv put secret/prod/database \
    host="${DB_HOST}" \
    username="${DB_USER}" \
    password="${DB_PASS}"
    
  # API keys
  vault kv put secret/prod/api/github \
    token="${GITHUB_TOKEN}"
  ```
- [ ] Update applications to use Vault
- [ ] Remove secrets from code/configs
- [ ] Verify no secrets remain in repository

### Task 9: Create Backup Procedures (AC: 7)
- [ ] Setup Vault backup script
  ```bash
  #!/bin/bash
  # backup-vault.sh
  
  # Backup Vault data
  vault operator raft snapshot save \
    "vault-backup-$(date +%Y%m%d-%H%M%S).snapshot"
    
  # Upload to Azure Storage
  az storage blob upload \
    --container-name vault-backups \
    --file vault-backup-*.snapshot
  ```
- [ ] Schedule automated backups
- [ ] Test restore procedure
- [ ] Document DR process

---

## Dev Notes

### Vault Configuration File
```hcl
# /vault/config/config.hcl
ui = true
disable_mlock = true

listener "tcp" {
  address     = "0.0.0.0:8200"
  tls_disable = "false"
  tls_cert_file = "/vault/certs/cert.pem"
  tls_key_file  = "/vault/certs/key.pem"
}

storage "azure" {
  accountName = "vaultstorage"
  accountKey  = "${STORAGE_KEY}"
  container   = "vault"
}

seal "azurekeyvault" {
  tenant_id     = "${TENANT_ID}"
  client_id     = "${CLIENT_ID}"
  client_secret = "${CLIENT_SECRET}"
  vault_name    = "kv-vault-unseal"
  key_name      = "vault-unseal-key"
}

api_addr = "http://10.40.2.10:8200"
cluster_addr = "https://10.40.2.10:8201"
```

### Jenkins Vault Integration
```groovy
pipeline {
  agent any
  
  environment {
    VAULT_ADDR = 'http://10.40.2.10:8200'
    ROLE_ID = credentials('vault-role-id')
    SECRET_ID = credentials('vault-secret-id')
  }
  
  stages {
    stage('Get Secrets') {
      steps {
        script {
          // Authenticate with Vault
          def auth = sh(
            script: """
              curl -s -X POST \
                -d '{"role_id":"${ROLE_ID}","secret_id":"${SECRET_ID}"}' \
                ${VAULT_ADDR}/v1/auth/approle/login | jq -r '.auth.client_token'
            """,
            returnStdout: true
          ).trim()
          
          // Get database credentials
          def dbCreds = sh(
            script: """
              curl -s -H "X-Vault-Token: ${auth}" \
                ${VAULT_ADDR}/v1/secret/data/test/database | jq -r '.data.data'
            """,
            returnStdout: true
          )
          
          env.DB_USERNAME = readJSON(text: dbCreds).username
          env.DB_PASSWORD = readJSON(text: dbCreds).password
        }
      }
    }
  }
}
```

### Application Vault Integration (Node.js)
```javascript
const vault = require('node-vault')({
  endpoint: process.env.VAULT_ADDR || 'http://10.40.2.10:8200',
  token: process.env.VAULT_TOKEN
});

async function getSecrets() {
  try {
    const result = await vault.read('secret/data/test/database');
    return result.data.data;
  } catch (error) {
    console.error('Failed to retrieve secrets:', error);
    throw error;
  }
}
```

### Vault Policies
```hcl
# jenkins-policy.hcl
path "secret/data/test/*" {
  capabilities = ["read", "list"]
}

path "database/creds/readonly" {
  capabilities = ["read"]
}

path "pki/issue/internal" {
  capabilities = ["create", "update"]
}

# application-policy.hcl  
path "secret/data/{{identity.entity.aliases.azure.metadata.resource_group}}/*" {
  capabilities = ["read", "list"]
}
```

### Testing Standards
- Test location: `/tests/infrastructure/security/`
- Validate Vault is sealed initially
- Test unseal process works
- Verify secret retrieval
- Test audit logs are created
- Validate backup/restore

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_