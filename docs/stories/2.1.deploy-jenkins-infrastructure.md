# Story 2.1: Deploy Jenkins Infrastructure

**Epic:** 2 - CI/CD Pipeline Foundation  
**Story Number:** 2.1  
**Title:** Deploy Jenkins Master and Test Instances  
**Status:** READY  
**Points:** 5  
**Components:** 301 (Jenkins Master), 501 (Test Jenkins)  

---

## Story

**As a** DevOps Engineer,  
**I want** to deploy Jenkins Master and Test instances with proper configuration,  
**so that** we have a scalable CI/CD platform for build and test automation.

---

## Acceptance Criteria

1. Jenkins Master deployed on VM at 10.60.2.10
2. Jenkins Test deployed on VM at 10.60.2.20
3. Both instances accessible only through private network
4. Jenkins configured with Azure AD authentication
5. Distributed build agents configured
6. Backup strategy implemented for Jenkins home
7. Jenkins plugins for security scanning installed
8. Pipeline libraries configured for shared code

---

## Tasks / Subtasks

### Task 1: Write Infrastructure Tests (TDD) (AC: 1, 2)
- [ ] Create `compute/jenkins_test.go`
  - [ ] Test VM creation with correct specs
  - [ ] Test network configuration
  - [ ] Test Jenkins installation validation
  - [ ] Test plugin installation verification
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Deploy Jenkins Master VM (AC: 1, 3)
- [ ] Create Terraform module for Jenkins VM
  ```hcl
  resource "azurerm_linux_virtual_machine" "jenkins_master" {
    name                = "vm-jenkins-master"
    resource_group_name = var.resource_group_name
    location            = var.location
    size               = "Standard_D4s_v3"
    
    network_interface_ids = [
      azurerm_network_interface.jenkins_master.id
    ]
    
    source_image_reference {
      publisher = "Canonical"
      offer     = "UbuntuServer"
      sku       = "18.04-LTS"
      version   = "latest"
    }
  }
  ```
- [ ] Configure private IP address (10.60.2.10)
- [ ] Attach data disk for Jenkins home
- [ ] Configure NSG rules for Jenkins

### Task 3: Deploy Jenkins Test VM (AC: 2, 3)
- [ ] Create VM for Test Jenkins
  - [ ] Size: Standard_D2s_v3
  - [ ] Private IP: 10.60.2.20
  - [ ] Same subnet as Master
- [ ] Configure for test execution
- [ ] Install test frameworks

### Task 4: Install and Configure Jenkins (AC: 4, 5)
- [ ] Create installation script
  ```bash
  #!/bin/bash
  # Install Java
  sudo apt update
  sudo apt install -y openjdk-11-jdk
  
  # Install Jenkins
  wget -q -O - https://pkg.jenkins.io/debian/jenkins.io.key | sudo apt-key add -
  sudo sh -c 'echo deb http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list'
  sudo apt update
  sudo apt install -y jenkins
  
  # Configure Jenkins
  sudo systemctl enable jenkins
  sudo systemctl start jenkins
  ```
- [ ] Configure Azure AD authentication
- [ ] Setup distributed builds
- [ ] Configure executor limits

### Task 5: Install Required Plugins (AC: 7)
- [ ] Install security plugins
  - [ ] OWASP Dependency Check
  - [ ] SonarQube Scanner
  - [ ] Docker Pipeline
  - [ ] HashiCorp Vault
  - [ ] Azure Key Vault
- [ ] Install pipeline plugins
  - [ ] Blue Ocean
  - [ ] Pipeline: AWS Steps
  - [ ] Kubernetes CLI
- [ ] Configure global tool installations

### Task 6: Setup Backup Strategy (AC: 6)
- [ ] Configure Jenkins backup plugin
- [ ] Create Azure Blob storage for backups
- [ ] Schedule daily backups
- [ ] Test restore procedure
- [ ] Document recovery process

### Task 7: Configure Shared Libraries (AC: 8)
- [ ] Create shared pipeline library repo
- [ ] Add common pipeline functions
  - [ ] Security scanning
  - [ ] Docker build/push
  - [ ] Notification helpers
- [ ] Configure Jenkins to use library
- [ ] Test library functions

---

## Dev Notes

### Jenkins Configuration Files

```groovy
// jenkins.yaml - Configuration as Code
jenkins:
  systemMessage: "SecDevOps CI/CD - Jenkins Master"
  numExecutors: 2
  mode: EXCLUSIVE
  
  securityRealm:
    azureSecurityRealm:
      clientId: "${AZURE_CLIENT_ID}"
      clientSecret: "${AZURE_CLIENT_SECRET}"
      tenant: "${AZURE_TENANT_ID}"
      
  authorizationStrategy:
    roleBased:
      roles:
        - name: "admin"
          permissions:
            - "Overall/Administer"
        - name: "developer"
          permissions:
            - "Job/Build"
            - "Job/Read"
            
  clouds:
    - azure:
        azureCredentialsId: "azure-sp"
        deploymentTimeout: 600
        maxVirtualMachinesLimit: 10
        resourceGroupReferenceType: "existing"
```

### Required Jenkins Plugins
```
azure-ad
docker-workflow
hashicorp-vault-plugin
sonar
dependency-check-jenkins-plugin
blueocean
pipeline-aws
kubernetes-cli
configuration-as-code
job-dsl
git
github
workflow-aggregator
```

### Network Security Rules
```hcl
# Jenkins Web UI (internal only)
Port 8080: Allow from 10.0.0.0/8
# Jenkins Agent Port
Port 50000: Allow from 10.60.2.0/24
# SSH for administration
Port 22: Allow from Bastion subnet only
```

### Backup Configuration
```yaml
Backup Schedule: Daily at 2 AM
Retention: 30 days
Items to backup:
- /var/lib/jenkins/jobs/
- /var/lib/jenkins/users/
- /var/lib/jenkins/secrets/
- /var/lib/jenkins/plugins/
- /var/lib/jenkins/config.xml
```

### Shared Library Structure
```
vars/
├── dockerBuild.groovy
├── securityScan.groovy
├── deployToAzure.groovy
├── runTests.groovy
└── sendNotification.groovy

src/
└── com/
    └── oversight/
        ├── Docker.groovy
        ├── Security.groovy
        └── Azure.groovy
```

### Testing Standards
- Test location: `/tests/infrastructure/compute/`
- Validate Jenkins is accessible
- Validate plugins are installed
- Test backup and restore
- Verify authentication works

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_