# Story 1.1: TDD Infrastructure Test Suite Setup

**Epic:** 1 - Secure Access Infrastructure  
**Story Number:** 1.1  
**Title:** TDD Infrastructure Test Suite Setup  
**Status:** READY  
**Points:** 3  

---

## Story

**As a** DevOps Engineer,  
**I want** to set up a comprehensive infrastructure testing framework using Terratest,  
**so that** I can write tests first before implementing any infrastructure code (TDD approach).

---

## Acceptance Criteria

1. Terratest framework is installed and configured in the project
2. Test structure follows Go testing standards in `/tests/infrastructure/` directory
3. Basic test helper functions are created for common Azure operations
4. CI/CD pipeline runs infrastructure tests before any deployment
5. Test report generation is configured with proper formatting
6. Example test demonstrates testing a simple Azure resource
7. Documentation explains how to write and run infrastructure tests
8. All tests can run in isolated test resource group

---

## Tasks / Subtasks

### Task 1: Setup Terratest Framework (AC: 1, 2)
- [ ] Create `/tests/infrastructure/` directory structure
- [ ] Initialize Go module for Terratest
- [ ] Install Terratest dependencies
- [ ] Create `go.mod` and `go.sum` files
- [ ] Setup `.gitignore` for Go test artifacts

### Task 2: Create Test Helpers (AC: 3, 8)
- [ ] Create `test_helpers.go` with common Azure functions
  - [ ] Function to create test resource group
  - [ ] Function to cleanup test resources
  - [ ] Function to validate Azure resources exist
  - [ ] Function to test network connectivity
- [ ] Create `test_config.go` for test configuration
  - [ ] Test environment variables
  - [ ] Test resource naming conventions
  - [ ] Retry logic configuration

### Task 3: Write Example Test (AC: 6)
- [ ] Create `example_test.go` demonstrating basic resource test
  - [ ] Test resource group creation
  - [ ] Test resource tagging
  - [ ] Test resource deletion
- [ ] Add comments explaining TDD pattern

### Task 4: Configure Test Execution (AC: 4, 5)
- [ ] Create `Makefile` with test targets
  - [ ] `make test-infrastructure` - Run all infrastructure tests
  - [ ] `make test-network` - Run network-specific tests
  - [ ] `make test-security` - Run security-specific tests
- [ ] Create test report generation script
  - [ ] JSON output for CI/CD
  - [ ] HTML report for developers
  - [ ] Coverage reporting

### Task 5: CI/CD Integration (AC: 4)
- [ ] Update Jenkins pipeline to run tests
  - [ ] Add test stage before infrastructure deployment
  - [ ] Configure test failure to block deployment
  - [ ] Archive test results
- [ ] Create GitHub Actions workflow for PR validation

### Task 6: Documentation (AC: 7)
- [ ] Create `/docs/testing/INFRASTRUCTURE-TESTING.md`
  - [ ] How to write Terratest tests
  - [ ] TDD workflow explanation
  - [ ] Common test patterns
  - [ ] Troubleshooting guide
- [ ] Add examples for each component type

---

## Dev Notes

### Testing Standards
- **Test Location:** `/tests/infrastructure/`
- **Test Naming:** `*_test.go` (Go standard)
- **Test Grouping:** One test file per Terraform module
- **Test Isolation:** Each test runs in separate resource group with cleanup

### Directory Structure
```
/tests/
├── infrastructure/
│   ├── test_helpers.go
│   ├── test_config.go
│   ├── example_test.go
│   ├── network/
│   │   ├── vnet_test.go
│   │   ├── nsg_test.go
│   │   └── firewall_test.go
│   ├── security/
│   │   ├── waf_test.go
│   │   └── appgateway_test.go
│   └── compute/
│       └── container_test.go
├── Makefile
└── go.mod
```

### Terratest Example Pattern
```go
func TestNetworkSecurityGroup(t *testing.T) {
    t.Parallel()
    
    // Arrange
    terraformOptions := &terraform.Options{
        TerraformDir: "../../terraform/modules/network",
        Vars: map[string]interface{}{
            "resource_group_name": fmt.Sprintf("rg-test-%s", random.UniqueId()),
            "location": "eastus",
        },
    }
    defer terraform.Destroy(t, terraformOptions)
    
    // Act
    terraform.InitAndApply(t, terraformOptions)
    
    // Assert
    nsgName := terraform.Output(t, terraformOptions, "nsg_name")
    assert.NotEmpty(t, nsgName)
    
    // Additional validations
    ValidateNSGRules(t, nsgName)
}
```

### Required Go Packages
```
github.com/gruntwork-io/terratest/modules/terraform
github.com/gruntwork-io/terratest/modules/azure
github.com/stretchr/testify/assert
github.com/stretchr/testify/require
```

### Environment Variables for Tests
```bash
# Test configuration
export ARM_SUBSCRIPTION_ID="..."
export ARM_CLIENT_ID="..."
export ARM_CLIENT_SECRET="..."
export ARM_TENANT_ID="..."
export TEST_RESOURCE_GROUP_PREFIX="rg-test-oversight"
export TEST_LOCATION="eastus"
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_