# Story 3.3: Setup Test Automation Framework

**Epic:** 3 - Test Environment & Automation  
**Story Number:** 3.3  
**Title:** Configure Playwright, Jest, and API Tests  
**Status:** READY  
**Points:** 8  
**Components:** 511 (Playwright), 512 (Jest), 514 (API Tests)  

---

## Story

**As a** QA Lead,  
**I want** comprehensive test automation frameworks configured,  
**so that** all types of tests can run automatically against the test environment.

---

## Acceptance Criteria

1. Playwright configured for E2E browser testing (511)
2. Jest configured for unit/integration testing (512)
3. API testing framework for REST/GraphQL endpoints (514)
4. Tests run in parallel for efficiency
5. Test data management integrated with DB states
6. Test reports generated in multiple formats
7. Screenshots/videos captured for failures
8. Tests integrated with CI/CD pipeline

---

## Tasks / Subtasks

### Task 1: Write Framework Tests (TDD) (AC: 1, 2, 3)
- [ ] Create `test-framework/framework_test.go`
  - [ ] Test Playwright installation works
  - [ ] Test Jest runs successfully
  - [ ] Test API framework executes
  - [ ] Test parallel execution
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Setup Playwright for E2E (AC: 1, 7)
- [ ] Install and configure Playwright
  ```json
  // playwright.config.js
  module.exports = {
    testDir: './tests/e2e',
    timeout: 30000,
    expect: {
      timeout: 5000
    },
    fullyParallel: true,
    forbidOnly: !!process.env.CI,
    retries: process.env.CI ? 2 : 0,
    workers: process.env.CI ? 1 : undefined,
    reporter: [
      ['html'],
      ['json', { outputFile: 'test-results/playwright.json' }],
      ['junit', { outputFile: 'test-results/playwright.xml' }]
    ],
    use: {
      baseURL: 'http://10.40.1.10:3000',
      trace: 'on-first-retry',
      screenshot: 'only-on-failure',
      video: 'retain-on-failure'
    },
    projects: [
      {
        name: 'chromium',
        use: { ...devices['Desktop Chrome'] }
      },
      {
        name: 'firefox',
        use: { ...devices['Desktop Firefox'] }
      },
      {
        name: 'webkit',
        use: { ...devices['Desktop Safari'] }
      },
      {
        name: 'Mobile Chrome',
        use: { ...devices['Pixel 5'] }
      }
    ]
  };
  ```
- [ ] Create E2E test examples
  ```javascript
  // tests/e2e/login.spec.js
  const { test, expect } = require('@playwright/test');
  
  test.describe('Login Flow', () => {
    test.beforeEach(async ({ page }) => {
      await page.goto('/');
    });
    
    test('successful login', async ({ page }) => {
      await page.fill('[data-testid="email"]', 'test@example.com');
      await page.fill('[data-testid="password"]', 'password123');
      await page.click('[data-testid="login-button"]');
      
      await expect(page).toHaveURL('/dashboard');
      await expect(page.locator('[data-testid="welcome-message"]'))
        .toContainText('Welcome back');
    });
    
    test('invalid credentials', async ({ page }) => {
      await page.fill('[data-testid="email"]', 'invalid@example.com');
      await page.fill('[data-testid="password"]', 'wrongpass');
      await page.click('[data-testid="login-button"]');
      
      await expect(page.locator('[data-testid="error-message"]'))
        .toContainText('Invalid credentials');
    });
  });
  ```
- [ ] Configure screenshot/video capture
- [ ] Setup browser contexts for isolation

### Task 3: Configure Jest Testing (AC: 2)
- [ ] Setup Jest configuration
  ```javascript
  // jest.config.js
  module.exports = {
    displayName: 'Unit Tests',
    testMatch: ['**/__tests__/**/*.js', '**/*.test.js'],
    testEnvironment: 'node',
    coverageDirectory: 'coverage',
    collectCoverageFrom: [
      'src/**/*.js',
      '!src/**/*.test.js',
      '!src/index.js'
    ],
    coverageThreshold: {
      global: {
        branches: 80,
        functions: 80,
        lines: 80,
        statements: 80
      }
    },
    setupFilesAfterEnv: ['<rootDir>/tests/setup.js'],
    transform: {
      '^.+\\.jsx?$': 'babel-jest'
    },
    moduleNameMapper: {
      '^@/(.*)$': '<rootDir>/src/$1'
    }
  };
  ```
- [ ] Create unit test examples
  ```javascript
  // src/utils/validation.test.js
  const { validateEmail, validatePassword } = require('./validation');
  
  describe('Validation Utils', () => {
    describe('validateEmail', () => {
      test('accepts valid email', () => {
        expect(validateEmail('user@example.com')).toBe(true);
      });
      
      test('rejects invalid email', () => {
        expect(validateEmail('invalid')).toBe(false);
        expect(validateEmail('@example.com')).toBe(false);
        expect(validateEmail('user@')).toBe(false);
      });
    });
    
    describe('validatePassword', () => {
      test('accepts strong password', () => {
        expect(validatePassword('StrongP@ss123')).toBe(true);
      });
      
      test('rejects weak password', () => {
        expect(validatePassword('weak')).toBe(false);
        expect(validatePassword('12345678')).toBe(false);
      });
    });
  });
  ```
- [ ] Setup test utilities
- [ ] Configure mocking libraries

### Task 4: Setup API Testing Framework (AC: 3)
- [ ] Configure REST API testing
  ```javascript
  // tests/api/rest.test.js
  const request = require('supertest');
  const app = require('../../src/app');
  
  describe('REST API Tests', () => {
    let server;
    let authToken;
    
    beforeAll(async () => {
      server = app.listen(0);
      const response = await request(server)
        .post('/api/auth/login')
        .send({ email: 'test@example.com', password: 'password123' });
      authToken = response.body.token;
    });
    
    afterAll(() => {
      server.close();
    });
    
    describe('GET /api/users', () => {
      test('returns user list with auth', async () => {
        const response = await request(server)
          .get('/api/users')
          .set('Authorization', `Bearer ${authToken}`)
          .expect(200);
        
        expect(response.body).toHaveProperty('users');
        expect(Array.isArray(response.body.users)).toBe(true);
      });
      
      test('returns 401 without auth', async () => {
        await request(server)
          .get('/api/users')
          .expect(401);
      });
    });
    
    describe('POST /api/users', () => {
      test('creates new user', async () => {
        const newUser = {
          email: 'new@example.com',
          name: 'New User',
          role: 'member'
        };
        
        const response = await request(server)
          .post('/api/users')
          .set('Authorization', `Bearer ${authToken}`)
          .send(newUser)
          .expect(201);
        
        expect(response.body).toMatchObject(newUser);
        expect(response.body).toHaveProperty('id');
      });
    });
  });
  ```
- [ ] Configure GraphQL testing
  ```javascript
  // tests/api/graphql.test.js
  const { graphql } = require('graphql');
  const schema = require('../../src/graphql/schema');
  
  describe('GraphQL API Tests', () => {
    test('user query returns user data', async () => {
      const query = `
        query GetUser($id: ID!) {
          user(id: $id) {
            id
            email
            name
            createdAt
          }
        }
      `;
      
      const result = await graphql({
        schema,
        source: query,
        variableValues: { id: '123' },
        contextValue: { user: { id: '123', role: 'admin' } }
      });
      
      expect(result.data.user).toEqual({
        id: '123',
        email: 'test@example.com',
        name: 'Test User',
        createdAt: expect.any(String)
      });
    });
    
    test('createProject mutation', async () => {
      const mutation = `
        mutation CreateProject($input: ProjectInput!) {
          createProject(input: $input) {
            id
            name
            status
          }
        }
      `;
      
      const result = await graphql({
        schema,
        source: mutation,
        variableValues: {
          input: {
            name: 'New Project',
            description: 'Test project'
          }
        },
        contextValue: { user: { id: '123', role: 'admin' } }
      });
      
      expect(result.data.createProject).toMatchObject({
        name: 'New Project',
        status: 'active'
      });
    });
  });
  ```
- [ ] Setup API mocking
- [ ] Configure load testing

### Task 5: Implement Parallel Execution (AC: 4)
- [ ] Configure parallel test execution
  ```json
  // package.json
  {
    "scripts": {
      "test:parallel": "npm-run-all --parallel test:unit test:integration test:e2e test:api",
      "test:unit": "jest --maxWorkers=4",
      "test:integration": "jest --config=jest.integration.config.js --maxWorkers=2",
      "test:e2e": "playwright test --workers=4",
      "test:api": "jest --config=jest.api.config.js --runInBand"
    }
  }
  ```
- [ ] Setup test sharding
  ```groovy
  // Jenkinsfile
  stage('Parallel Tests') {
    parallel {
      stage('Unit Tests') {
        steps {
          sh 'npm run test:unit -- --shard=1/2'
        }
      }
      stage('Unit Tests 2') {
        steps {
          sh 'npm run test:unit -- --shard=2/2'
        }
      }
      stage('E2E Tests') {
        steps {
          sh 'npm run test:e2e -- --shard=1/3'
        }
      }
      stage('API Tests') {
        steps {
          sh 'npm run test:api'
        }
      }
    }
  }
  ```
- [ ] Optimize test distribution
- [ ] Configure test balancing

### Task 6: Setup Test Data Management (AC: 5)
- [ ] Create test data factory
  ```javascript
  // tests/fixtures/factory.js
  const faker = require('faker');
  
  class TestDataFactory {
    static createUser(overrides = {}) {
      return {
        id: faker.datatype.uuid(),
        email: faker.internet.email(),
        name: faker.name.findName(),
        password: 'Test123!',
        createdAt: new Date(),
        ...overrides
      };
    }
    
    static createProject(overrides = {}) {
      return {
        id: faker.datatype.uuid(),
        name: faker.commerce.productName(),
        description: faker.lorem.paragraph(),
        status: 'active',
        ...overrides
      };
    }
    
    static async seedDatabase(state) {
      switch(state) {
        case 1:
          // Schema only, no seeding
          break;
        case 2:
          // Seed framework data
          await this.seedFrameworkData();
          break;
        case 3:
          // Seed full test data
          await this.seedFullTestData();
          break;
      }
    }
    
    static async cleanupTestData(testId) {
      // Clean up data created during test
      await db.query('DELETE FROM test_artifacts WHERE test_id = $1', [testId]);
    }
  }
  ```
- [ ] Integrate with DB state switching
- [ ] Create data cleanup routines
- [ ] Setup test isolation

### Task 7: Configure Test Reporting (AC: 6)
- [ ] Setup multi-format reporting
  ```javascript
  // tests/reporters/custom-reporter.js
  class CustomReporter {
    onRunStart(results, options) {
      console.log('Test run started');
    }
    
    onTestResult(test, testResult) {
      const { testResults } = testResult;
      testResults.forEach(result => {
        console.log(`${result.status}: ${result.title}`);
        if (result.status === 'failed') {
          console.log(result.failureMessages);
        }
      });
    }
    
    onRunComplete(contexts, results) {
      const { numFailedTests, numPassedTests, numTotalTests } = results;
      console.log(`
        Test Results:
        Total: ${numTotalTests}
        Passed: ${numPassedTests}
        Failed: ${numFailedTests}
        Coverage: ${results.coverageMap ? 'Available' : 'Not collected'}
      `);
      
      // Send to dashboard
      this.sendToDashboard(results);
    }
    
    async sendToDashboard(results) {
      await fetch('http://dashboard/api/test-results', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          timestamp: new Date(),
          results: results,
          environment: 'test',
          buildNumber: process.env.BUILD_NUMBER
        })
      });
    }
  }
  ```
- [ ] Create HTML reports
- [ ] Setup trend analysis
- [ ] Configure allure reporting

### Task 8: CI/CD Integration (AC: 8)
- [ ] Integrate with Jenkins pipeline
- [ ] Configure test gates
- [ ] Setup artifact archiving
- [ ] Create test dashboard

---

## Dev Notes

### Test Execution Matrix
```yaml
test_matrix:
  browsers: [chrome, firefox, safari, edge]
  viewports: [desktop, tablet, mobile]
  environments: [test, staging]
  data_states: [1, 2, 3]
```

### Performance Targets
- Unit tests: < 5 minutes
- Integration tests: < 10 minutes
- E2E tests: < 20 minutes
- API tests: < 5 minutes
- Total pipeline: < 30 minutes

### Testing Standards
- Test location: `/tests/`
- Naming: `*.test.js`, `*.spec.js`
- Coverage minimum: 80%
- Screenshots on failure
- Retry flaky tests 2x

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_