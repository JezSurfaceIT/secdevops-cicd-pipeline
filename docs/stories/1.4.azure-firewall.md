# Story 1.4: Implement Azure Firewall

**Epic:** 1 - Secure Access Infrastructure  
**Story Number:** 1.4  
**Title:** Deploy and Configure Azure Firewall  
**Status:** READY  
**Points:** 5  
**Component:** 811 (Azure Firewall)  

---

## Story

**As a** Network Administrator,  
**I want** to deploy Azure Firewall to control all internal traffic,  
**so that** we have centralized network security and traffic inspection.

---

## Acceptance Criteria

1. Azure Firewall deployed in hub network (10.10.0.4)
2. Firewall subnet created with /26 address space (10.10.0.0/26)
3. All internal traffic routes through the firewall
4. Network rules configured for allowed traffic flows
5. Application rules configured for FQDN filtering
6. DNAT rules configured for inbound traffic from App Gateway
7. Firewall logs sent to Log Analytics
8. All infrastructure tests pass before deployment
9. User-Defined Routes (UDRs) force traffic through firewall

---

## Tasks / Subtasks

### Task 1: Write Infrastructure Tests First (TDD) (AC: 8)
- [ ] Create `network/firewall_test.go`
  - [ ] Test firewall creation in correct subnet
  - [ ] Test firewall has correct IP configuration
  - [ ] Test network rules exist
  - [ ] Test application rules exist
  - [ ] Test DNAT rules exist
- [ ] Create `network/route_table_test.go`
  - [ ] Test route tables exist for each subnet
  - [ ] Test default route points to firewall
  - [ ] Test specific routes for inter-subnet traffic
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Create Firewall Module (AC: 1, 2)
- [ ] Create `/terraform/modules/firewall/main.tf`
  - [ ] Define Azure Firewall resource
  - [ ] Configure Standard SKU (or Premium if needed)
  - [ ] Set up firewall IP configuration
- [ ] Create firewall subnet if not exists
  - [ ] Name must be "AzureFirewallSubnet"
  - [ ] Address space: 10.10.0.0/26
- [ ] Configure firewall policy
  - [ ] Create reusable rule collections
  - [ ] Set threat intelligence mode

### Task 3: Configure Network Rules (AC: 4)
- [ ] Create network rule collections
  - [ ] Jenkins to ACR (10.60.2.0/24 -> 10.60.3.0/24)
  - [ ] Test environment to databases (10.40.1.0/24 -> 10.40.2.0/24)
  - [ ] Monitoring access (10.90.1.0/24 -> all)
- [ ] Define protocols and ports
  - [ ] HTTPS (443)
  - [ ] PostgreSQL (5432)
  - [ ] Redis (6379)
  - [ ] Custom application ports

### Task 4: Configure Application Rules (AC: 5)
- [ ] Create application rule collections
  - [ ] Allow Azure services FQDNs
  - [ ] Allow GitHub.com for git operations
  - [ ] Allow Docker Hub if needed
  - [ ] Allow Windows/Linux update servers
- [ ] Configure TLS inspection if using Premium SKU
- [ ] Set up web categories filtering

### Task 5: Configure DNAT Rules (AC: 6)
- [ ] Create DNAT rule collection
  - [ ] Route App Gateway traffic to backend pools
  - [ ] Map public IP/port to private IP/port
- [ ] Configure source NAT for outbound traffic
- [ ] Test connectivity through DNAT rules

### Task 6: Setup Routing (AC: 3, 9)
- [ ] Create User-Defined Routes (UDRs) for each subnet
  - [ ] Default route (0.0.0.0/0) -> Firewall IP
  - [ ] Exclude AzureFirewallSubnet from UDRs
  - [ ] Exclude AzureBastionSubnet (special routing)
- [ ] Associate route tables with subnets
- [ ] Configure route propagation settings
- [ ] Test traffic flows through firewall

### Task 7: Configure Monitoring (AC: 7)
- [ ] Enable diagnostic settings
  - [ ] Send logs to Log Analytics
  - [ ] Configure log categories
  - [ ] Set retention period
- [ ] Create workbook for firewall analytics
- [ ] Set up alerts
  - [ ] High number of denied connections
  - [ ] Firewall health degradation
  - [ ] SNAT port exhaustion

### Task 8: Run Tests and Deploy (AC: 8)
- [ ] Run all infrastructure tests
  - [ ] Firewall tests should pass
  - [ ] Routing tests should pass
- [ ] Deploy to test environment
- [ ] Validate traffic flows
- [ ] Document firewall rules

---

## Dev Notes

### Azure Firewall Configuration

```hcl
resource "azurerm_firewall" "main" {
  name                = "fw-oversight-main"
  location            = var.location
  resource_group_name = var.resource_group_name
  sku_tier           = "Standard"
  sku_name           = "AZFW_VNet"

  ip_configuration {
    name                 = "configuration"
    subnet_id            = azurerm_subnet.firewall.id
    public_ip_address_id = azurerm_public_ip.firewall.id
  }

  firewall_policy_id = azurerm_firewall_policy.main.id
}

resource "azurerm_firewall_policy" "main" {
  name                = "fwpolicy-oversight"
  resource_group_name = var.resource_group_name
  location            = var.location

  threat_intelligence_mode = "Alert"
}
```

### Network Rule Collection Example

```hcl
resource "azurerm_firewall_policy_rule_collection_group" "network" {
  name               = "network-rules"
  firewall_policy_id = azurerm_firewall_policy.main.id
  priority          = 100

  network_rule_collection {
    name     = "jenkins-to-acr"
    priority = 110
    action   = "Allow"

    rule {
      name                  = "jenkins-acr-access"
      protocols            = ["TCP"]
      source_addresses     = ["10.60.2.0/24"]
      destination_addresses = ["10.60.3.0/24"]
      destination_ports    = ["443", "80"]
    }
  }

  network_rule_collection {
    name     = "test-to-database"
    priority = 120
    action   = "Allow"

    rule {
      name                  = "postgresql-access"
      protocols            = ["TCP"]
      source_addresses     = ["10.40.1.0/24"]
      destination_addresses = ["10.40.2.0/24"]
      destination_ports    = ["5432"]
    }
  }
}
```

### Application Rule Collection Example

```hcl
resource "azurerm_firewall_policy_rule_collection_group" "application" {
  name               = "application-rules"
  firewall_policy_id = azurerm_firewall_policy.main.id
  priority          = 200

  application_rule_collection {
    name     = "allow-azure-services"
    priority = 210
    action   = "Allow"

    rule {
      name = "azure-services"
      source_addresses = ["10.0.0.0/8"]
      
      protocols {
        type = "Https"
        port = 443
      }
      
      destination_fqdns = [
        "*.azure.com",
        "*.azurewebsites.net",
        "*.azurecr.io"
      ]
    }
  }
}
```

### Route Table Configuration

```hcl
resource "azurerm_route_table" "subnet_routes" {
  for_each = var.subnet_route_tables
  
  name                = "rt-${each.key}"
  location            = var.location
  resource_group_name = var.resource_group_name

  route {
    name                   = "default-to-firewall"
    address_prefix         = "0.0.0.0/0"
    next_hop_type         = "VirtualAppliance"
    next_hop_in_ip_address = azurerm_firewall.main.ip_configuration[0].private_ip_address
  }
}

resource "azurerm_subnet_route_table_association" "subnet_routes" {
  for_each = var.subnet_route_tables
  
  subnet_id      = azurerm_subnet.subnets[each.key].id
  route_table_id = azurerm_route_table.subnet_routes[each.key].id
}
```

### Testing Standards
- Test location: `/tests/infrastructure/network/`  
- Validate firewall blocks unauthorized traffic
- Validate allowed traffic flows work
- Test DNAT rules function correctly
- Verify logs are being collected

### Monitoring Queries

```kusto
// Denied connections by source
AzureDiagnostics
| where Category == "AzureFirewallNetworkRule"
| where Action == "Deny"
| summarize count() by src_ip_s, dest_ip_s
| order by count_ desc

// Application rule hits
AzureDiagnostics  
| where Category == "AzureFirewallApplicationRule"
| where Action == "Allow"
| summarize count() by fqdn_s
| order by count_ desc
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_