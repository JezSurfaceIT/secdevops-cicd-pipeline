# Story 2.4: Setup Security Scanning Pipeline

**Epic:** 2 - CI/CD Pipeline Foundation  
**Story Number:** 2.4  
**Title:** Integrate All 7 Security Scanning Tools  
**Status:** READY  
**Points:** 8  
**Components:** 307.1-307.7 (Security Suite)  

---

## Story

**As a** Security Officer,  
**I want** comprehensive security scanning integrated into the CI/CD pipeline,  
**so that** vulnerabilities are detected and blocked before reaching production.

---

## Acceptance Criteria

1. TruffleHog (307.1) scanning for secrets in code
2. SonarQube (307.2) performing SAST and code quality analysis
3. Snyk (307.3) checking dependencies for vulnerabilities
4. Semgrep (307.4) running pattern-based security checks
5. Trivy (307.5) scanning container images
6. Checkov (307.6) validating Infrastructure as Code
7. GitLeaks (307.7) checking git history for secrets
8. Security dashboard aggregating all scan results
9. Pipeline fails on critical vulnerabilities
10. Reports generated for compliance

---

## Tasks / Subtasks

### Task 1: Write Security Tests (TDD) (AC: 1-7)
- [ ] Create `security/scanning_pipeline_test.go`
  - [ ] Test each scanner executes
  - [ ] Test critical findings block pipeline
  - [ ] Test reports are generated
  - [ ] Test dashboard receives data
- [ ] Create test cases with known vulnerabilities
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Deploy TruffleHog (AC: 1)
- [ ] Install TruffleHog in Jenkins
  ```groovy
  stage('Secret Scanning - TruffleHog') {
    steps {
      script {
        sh '''
          docker run --rm -v ${WORKSPACE}:/src \
            trufflesecurity/trufflehog:latest \
            filesystem /src \
            --json \
            --no-verification \
            > trufflehog-report.json
        '''
        
        def report = readJSON file: 'trufflehog-report.json'
        if (report.size() > 0) {
          error "Secrets detected in code! Check trufflehog-report.json"
        }
      }
    }
  }
  ```
- [ ] Configure pre-commit hook
  ```yaml
  # .pre-commit-config.yaml
  repos:
    - repo: https://github.com/trufflesecurity/trufflehog
      rev: v3.60.0
      hooks:
        - id: trufflehog
          args: ['--no-verification']
  ```
- [ ] Create custom rules for organization
- [ ] Setup allowlist for false positives

### Task 3: Configure SonarQube (AC: 2)
- [ ] Deploy SonarQube server
  ```yaml
  # docker-compose.sonarqube.yml
  version: '3'
  services:
    sonarqube:
      image: sonarqube:9-community
      ports:
        - "9000:9000"
      environment:
        - SONAR_JDBC_URL=jdbc:postgresql://db:5432/sonar
        - SONAR_JDBC_USERNAME=sonar
        - SONAR_JDBC_PASSWORD=${SONAR_DB_PASSWORD}
      volumes:
        - sonarqube_data:/opt/sonarqube/data
        - sonarqube_logs:/opt/sonarqube/logs
    
    db:
      image: postgres:13
      environment:
        - POSTGRES_USER=sonar
        - POSTGRES_PASSWORD=${SONAR_DB_PASSWORD}
        - POSTGRES_DB=sonar
      volumes:
        - postgresql_data:/var/lib/postgresql/data
  ```
- [ ] Configure quality gates
  ```groovy
  stage('SAST - SonarQube') {
    steps {
      withSonarQubeEnv('SonarQube') {
        sh '''
          sonar-scanner \
            -Dsonar.projectKey=oversight-mvp \
            -Dsonar.sources=. \
            -Dsonar.exclusions=**/tests/**,**/vendor/** \
            -Dsonar.tests=tests \
            -Dsonar.test.inclusions=**/*_test.go \
            -Dsonar.go.coverage.reportPaths=coverage.out
        '''
      }
      timeout(time: 1, unit: 'HOURS') {
        waitForQualityGate abortPipeline: true
      }
    }
  }
  ```
- [ ] Setup security hotspot review
- [ ] Configure OWASP rules

### Task 4: Integrate Snyk (AC: 3)
- [ ] Install Snyk CLI
  ```bash
  npm install -g snyk
  snyk auth ${SNYK_TOKEN}
  ```
- [ ] Configure dependency scanning
  ```groovy
  stage('Dependency Scan - Snyk') {
    steps {
      script {
        sh '''
          snyk test --severity-threshold=high \
            --json > snyk-report.json || true
          
          snyk monitor
        '''
        
        def report = readJSON file: 'snyk-report.json'
        if (report.vulnerabilities?.findAll { it.severity == 'critical' }.size() > 0) {
          error "Critical vulnerabilities found in dependencies!"
        }
      }
    }
  }
  ```
- [ ] Setup license checking
- [ ] Configure automatic PR fixes
- [ ] Create vulnerability database

### Task 5: Setup Semgrep (AC: 4)
- [ ] Install Semgrep
  ```bash
  pip install semgrep
  ```
- [ ] Configure security rules
  ```yaml
  # .semgrep.yml
  rules:
    - id: hardcoded-password
      pattern: password = "$Y"
      message: Hardcoded password detected
      severity: ERROR
      
    - id: sql-injection
      patterns:
        - pattern: |
            $QUERY = "..." + $INPUT + "..."
            $SQL.query($QUERY)
      message: Potential SQL injection
      severity: ERROR
  ```
- [ ] Run Semgrep in pipeline
  ```groovy
  stage('Pattern Scan - Semgrep') {
    steps {
      sh '''
        semgrep --config=auto \
          --json \
          --output=semgrep-report.json \
          .
      '''
      publishHTML([
        reportFiles: 'semgrep-report.json',
        reportName: 'Semgrep Security Report'
      ])
    }
  }
  ```
- [ ] Create custom rules for business logic
- [ ] Setup auto-fix suggestions

### Task 6: Configure Trivy (AC: 5)
- [ ] Install Trivy scanner
  ```bash
  curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  ```
- [ ] Scan container images
  ```groovy
  stage('Container Scan - Trivy') {
    steps {
      script {
        sh '''
          trivy image \
            --severity HIGH,CRITICAL \
            --format json \
            --output trivy-report.json \
            ${IMAGE_NAME}:${IMAGE_TAG}
        '''
        
        def report = readJSON file: 'trivy-report.json'
        def criticalVulns = report.Results?.collectMany { 
          it.Vulnerabilities?.findAll { it.Severity == 'CRITICAL' } 
        } ?: []
        
        if (criticalVulns.size() > 0) {
          error "Critical vulnerabilities in container image!"
        }
      }
    }
  }
  ```
- [ ] Scan IaC templates
- [ ] Configure vulnerability database updates
- [ ] Setup image signing after scan

### Task 7: Deploy Checkov (AC: 6)
- [ ] Install Checkov
  ```bash
  pip install checkov
  ```
- [ ] Scan Terraform code
  ```groovy
  stage('IaC Scan - Checkov') {
    steps {
      sh '''
        checkov -d terraform/ \
          --framework terraform \
          --output json \
          --output-file checkov-report.json \
          --soft-fail
      '''
      
      script {
        def report = readJSON file: 'checkov-report.json'
        if (report.summary.failed > 0) {
          unstable "Checkov found ${report.summary.failed} issues"
        }
      }
    }
  }
  ```
- [ ] Create custom policies
  ```python
  # custom_checkov_policy.py
  from checkov.common.models.enums import CheckResult, CheckCategories
  from checkov.terraform.checks.resource.base_resource_check import BaseResourceCheck
  
  class EnsureEncryption(BaseResourceCheck):
      def __init__(self):
          name = "Ensure all storage is encrypted"
          id = "CUSTOM_AZURE_1"
          supported_resources = ['azurerm_storage_account']
          categories = [CheckCategories.ENCRYPTION]
          super().__init__(name=name, id=id, categories=categories, 
                         supported_resources=supported_resources)
      
      def scan_resource_conf(self, conf):
          if conf.get("enable_https_traffic_only") == [True]:
              return CheckResult.PASSED
          return CheckResult.FAILED
  ```
- [ ] Configure compliance frameworks
- [ ] Setup drift detection

### Task 8: Implement GitLeaks (AC: 7)
- [ ] Install GitLeaks
  ```bash
  brew install gitleaks  # or download binary
  ```
- [ ] Scan git history
  ```groovy
  stage('History Scan - GitLeaks') {
    steps {
      sh '''
        gitleaks detect \
          --source . \
          --report-format json \
          --report-path gitleaks-report.json \
          --no-git
      '''
      
      script {
        if (fileExists('gitleaks-report.json')) {
          def report = readJSON file: 'gitleaks-report.json'
          if (report.size() > 0) {
            unstable "Secrets found in git history!"
          }
        }
      }
    }
  }
  ```
- [ ] Configure custom rules
  ```toml
  # .gitleaks.toml
  [[rules]]
  id = "azure-key"
  description = "Azure Storage Key"
  regex = '''AccountKey=[a-zA-Z0-9+/]{86}=='''
  tags = ["azure", "key"]
  ```
- [ ] Setup pre-receive hooks
- [ ] Create remediation process

### Task 9: Create Security Dashboard (AC: 8)
- [ ] Deploy dashboard application
  ```javascript
  // security-dashboard/app.js
  const express = require('express');
  const app = express();
  
  app.get('/api/scan-results', async (req, res) => {
    const results = {
      trufflehog: await getResults('trufflehog'),
      sonarqube: await getResults('sonarqube'),
      snyk: await getResults('snyk'),
      semgrep: await getResults('semgrep'),
      trivy: await getResults('trivy'),
      checkov: await getResults('checkov'),
      gitleaks: await getResults('gitleaks')
    };
    
    res.json({
      summary: aggregateResults(results),
      details: results,
      timestamp: new Date()
    });
  });
  ```
- [ ] Create visualization components
- [ ] Setup real-time updates
- [ ] Configure alerting thresholds

### Task 10: Configure Pipeline Gates (AC: 9, 10)
- [ ] Define security gates
  ```groovy
  def evaluateSecurityGates() {
    def gates = [
      trufflehog: [critical: 0, high: 0],
      sonarqube: [critical: 0, high: 5],
      snyk: [critical: 0, high: 10],
      semgrep: [critical: 0, high: 5],
      trivy: [critical: 0, high: 10],
      checkov: [critical: 0, high: 20],
      gitleaks: [critical: 0, high: 0]
    ]
    
    gates.each { tool, thresholds ->
      def report = readJSON file: "${tool}-report.json"
      if (report.critical > thresholds.critical) {
        error "${tool}: Critical issues exceed threshold"
      }
      if (report.high > thresholds.high) {
        unstable "${tool}: High issues exceed threshold"
      }
    }
  }
  ```
- [ ] Generate compliance reports
- [ ] Archive scan results
- [ ] Create exemption process

---

## Dev Notes

### Complete Pipeline Integration
```groovy
pipeline {
  agent any
  
  stages {
    stage('Security Scanning') {
      parallel {
        stage('Secrets') {
          steps {
            sh 'make scan-secrets'  // TruffleHog & GitLeaks
          }
        }
        stage('SAST') {
          steps {
            sh 'make scan-sast'     // SonarQube & Semgrep
          }
        }
        stage('Dependencies') {
          steps {
            sh 'make scan-deps'     // Snyk
          }
        }
        stage('Containers') {
          steps {
            sh 'make scan-containers' // Trivy
          }
        }
        stage('IaC') {
          steps {
            sh 'make scan-iac'      // Checkov
          }
        }
      }
    }
    
    stage('Evaluate Gates') {
      steps {
        evaluateSecurityGates()
      }
    }
  }
  
  post {
    always {
      publishSecurityReports()
      updateDashboard()
    }
  }
}
```

### Testing Standards
- Test location: `/tests/security/`
- Use known vulnerable code for testing
- Validate each scanner detects issues
- Test gate logic blocks deployment
- Verify reports are generated

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_