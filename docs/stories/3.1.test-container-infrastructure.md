# Story 3.1: Deploy Test Container Infrastructure

**Epic:** 3 - Test Environment & Automation  
**Story Number:** 3.1  
**Title:** Setup Azure Container Instance for Testing  
**Status:** READY  
**Points:** 5  
**Component:** 401 (Test Container Instance)  

---

## Story

**As a** Test Engineer,  
**I want** a dedicated containerized test environment,  
**so that** we have isolated, repeatable testing infrastructure.

---

## Acceptance Criteria

1. Azure Container Instance deployed in test subnet (10.40.1.0/24)
2. Container has 4 CPU cores and 8GB RAM minimum
3. Environment variables properly configured for test
4. Secrets pulled from HashiCorp Vault (303)
5. No public IP address assigned
6. Health monitoring and auto-restart configured
7. Log streaming to Azure Log Analytics
8. Container can be reset to clean state quickly

---

## Tasks / Subtasks

### Task 1: Write Infrastructure Tests (TDD) (AC: 1, 2, 5)
- [ ] Create `test-env/container_test.go`
  - [ ] Test container deployment successful
  - [ ] Test resource allocation correct
  - [ ] Test network configuration
  - [ ] Test no public access
  - [ ] Test health checks work
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Create Container Infrastructure (AC: 1, 2)
- [ ] Define Terraform module for test container
  ```hcl
  resource "azurerm_container_group" "test_env" {
    name                = "aci-test-environment"
    location            = var.location
    resource_group_name = "rg-oversight-test-acs-eastus"
    ip_address_type     = "Private"
    subnet_ids          = [azurerm_subnet.test_app.id]
    os_type             = "Linux"
    restart_policy      = "Always"
    
    container {
      name   = "test-app"
      image  = "${var.acr_login_server}/oversight-app:test"
      cpu    = "4"
      memory = "8"
      
      ports {
        port     = 3000
        protocol = "TCP"
      }
      
      ports {
        port     = 8080
        protocol = "TCP"
      }
      
      liveness_probe {
        http_get {
          path = "/health"
          port = 3000
        }
        initial_delay_seconds = 30
        period_seconds        = 10
        failure_threshold     = 3
      }
      
      readiness_probe {
        http_get {
          path = "/ready"
          port = 3000
        }
        initial_delay_seconds = 10
        period_seconds        = 5
      }
    }
    
    diagnostics {
      log_analytics {
        workspace_id  = var.log_analytics_workspace_id
        workspace_key = var.log_analytics_workspace_key
      }
    }
  }
  ```
- [ ] Configure resource limits
- [ ] Setup container registry access
- [ ] Define network security rules

### Task 3: Configure Environment Variables (AC: 3)
- [ ] Create environment configuration
  ```hcl
  environment_variables = {
    NODE_ENV           = "test"
    PORT              = "3000"
    LOG_LEVEL         = "debug"
    VAULT_ADDR        = "http://10.40.2.10:8200"
    DB_HOST           = "10.40.2.20"
    REDIS_HOST        = "10.40.2.30"
    ENABLE_METRICS    = "true"
    ENABLE_TRACING    = "true"
  }
  
  secure_environment_variables = {
    VAULT_TOKEN = data.azurerm_key_vault_secret.vault_token.value
    APP_KEY     = data.azurerm_key_vault_secret.app_key.value
  }
  ```
- [ ] Setup environment-specific configs
- [ ] Create configuration templates
- [ ] Document environment variables

### Task 4: Integrate Vault Secrets (AC: 4)
- [ ] Configure Vault agent sidecar
  ```hcl
  container {
    name   = "vault-agent"
    image  = "hashicorp/vault:1.15"
    cpu    = "0.5"
    memory = "0.5"
    
    commands = ["vault", "agent", "-config=/vault/config/agent.hcl"]
    
    volume {
      name       = "vault-config"
      mount_path = "/vault/config"
      secret = {
        "agent.hcl" = base64encode(local.vault_agent_config)
      }
    }
    
    volume {
      name       = "shared-secrets"
      mount_path = "/vault/secrets"
      empty_dir  = true
    }
  }
  ```
- [ ] Create Vault agent configuration
  ```hcl
  # vault-agent.hcl
  auto_auth {
    method {
      type = "azure"
      config {
        role = "test-app"
        resource = "https://management.azure.com/"
      }
    }
    
    sink {
      type = "file"
      config {
        path = "/vault/secrets/.vault-token"
      }
    }
  }
  
  template {
    source      = "/vault/templates/db.tmpl"
    destination = "/vault/secrets/db.env"
  }
  
  template {
    source      = "/vault/templates/api.tmpl"
    destination = "/vault/secrets/api.env"
  }
  ```
- [ ] Setup secret rotation
- [ ] Configure secret templates

### Task 5: Setup Health Monitoring (AC: 6)
- [ ] Configure health endpoints
  ```javascript
  // health.js
  app.get('/health', (req, res) => {
    const health = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      memory: process.memoryUsage(),
      checks: {
        database: await checkDatabase(),
        redis: await checkRedis(),
        vault: await checkVault()
      }
    };
    
    const isHealthy = Object.values(health.checks).every(c => c);
    res.status(isHealthy ? 200 : 503).json(health);
  });
  
  app.get('/ready', (req, res) => {
    const ready = {
      database: dbConnection.isReady(),
      cache: redisClient.isReady(),
      vault: vaultClient.isAuthenticated()
    };
    
    const isReady = Object.values(ready).every(r => r);
    res.status(isReady ? 200 : 503).json(ready);
  });
  ```
- [ ] Setup auto-restart policies
- [ ] Configure alerting
- [ ] Create health dashboard

### Task 6: Configure Log Streaming (AC: 7)
- [ ] Setup Fluent Bit for log collection
  ```dockerfile
  # Add Fluent Bit to container
  FROM fluent/fluent-bit:2.0 AS fluent-bit
  
  FROM node:18-alpine
  COPY --from=fluent-bit /fluent-bit/bin/fluent-bit /usr/local/bin/
  COPY fluent-bit.conf /etc/fluent-bit/
  
  # Start Fluent Bit alongside app
  CMD ["sh", "-c", "fluent-bit -c /etc/fluent-bit/fluent-bit.conf & node app.js"]
  ```
- [ ] Configure log forwarding
  ```ini
  # fluent-bit.conf
  [SERVICE]
      Flush        1
      Daemon       Off
      Log_Level    info
  
  [INPUT]
      Name              tail
      Path              /var/log/app/*.log
      Tag               app.logs
      Parser            json
      Mem_Buf_Limit     5MB
      Skip_Long_Lines   On
  
  [OUTPUT]
      Name                    azure
      Match                   app.*
      Customer_ID             ${WORKSPACE_ID}
      Shared_Key             ${WORKSPACE_KEY}
      Log_Type               TestEnvironment
  ```
- [ ] Setup log queries
- [ ] Create log retention policies

### Task 7: Implement State Reset (AC: 8)
- [ ] Create reset script
  ```bash
  #!/bin/bash
  # reset-test-env.sh
  
  echo "Resetting test environment..."
  
  # Stop container
  az container stop --name aci-test-environment \
    --resource-group rg-oversight-test-acs-eastus
  
  # Clear persistent volumes
  az storage file delete-batch \
    --source test-data \
    --account-name testenvstore
  
  # Reset database to state 1
  ./switch-db-state.sh 1
  
  # Clear cache
  redis-cli -h 10.40.2.30 FLUSHALL
  
  # Restart container
  az container start --name aci-test-environment \
    --resource-group rg-oversight-test-acs-eastus
  
  # Wait for health
  while ! curl -s http://10.40.1.10:3000/health > /dev/null; do
    echo "Waiting for container to be healthy..."
    sleep 5
  done
  
  echo "Test environment reset complete"
  ```
- [ ] Create snapshot capability
- [ ] Setup scheduled resets
- [ ] Document reset procedures

---

## Dev Notes

### Container Startup Script
```bash
#!/bin/sh
# startup.sh

# Source Vault secrets
source /vault/secrets/db.env
source /vault/secrets/api.env

# Run migrations
npm run migrate

# Seed test data if needed
if [ "$SEED_DATA" = "true" ]; then
  npm run seed
fi

# Start application
exec node app.js
```

### Resource Monitoring
```kusto
// Container resource usage
AzureMetrics
| where ResourceId contains "aci-test-environment"
| where MetricName in ("CPUUsage", "MemoryUsage")
| summarize avg(Average) by MetricName, bin(TimeGenerated, 5m)
| render timechart

// Container restarts
ContainerInstanceLog_CL
| where ContainerGroup_s == "aci-test-environment"
| where Message contains "container restarted"
| summarize RestartCount = count() by bin(TimeGenerated, 1h)
```

### Test Environment Access
```bash
# Access test environment logs
az container logs --name aci-test-environment \
  --resource-group rg-oversight-test-acs-eastus \
  --follow

# Execute commands in container
az container exec --name aci-test-environment \
  --resource-group rg-oversight-test-acs-eastus \
  --exec-command "/bin/sh"

# Get container status
az container show --name aci-test-environment \
  --resource-group rg-oversight-test-acs-eastus \
  --query instanceView.state
```

### Testing Standards
- Test location: `/tests/infrastructure/test-env/`
- Validate container starts successfully
- Test health endpoints respond
- Verify secrets are loaded
- Check logs are streaming

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_