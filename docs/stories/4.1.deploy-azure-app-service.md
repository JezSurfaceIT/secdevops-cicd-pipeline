# Story 4.1: Deploy Azure App Service

**Epic:** 4 - Production SaaS Deployment  
**Story Number:** 4.1  
**Title:** Setup App Service with Managed Identity  
**Status:** READY  
**Points:** 5  
**Component:** 701 (SaaS Application)  

---

## Story

**As a** Platform Engineer,  
**I want** to deploy the SaaS application to Azure App Service,  
**so that** we have a scalable, managed production platform with auto-scaling capabilities.

---

## Acceptance Criteria

1. Azure App Service deployed with Standard S2 or higher plan
2. Managed Identity configured for secure service access
3. Auto-scaling rules configured (2-10 instances)
4. Deployment slots for staging and production
5. Integration with existing codebase at `/home/jez/code/SaaS`
6. Private endpoint configured in subnet 10.20.2.0/24
7. Custom domain and SSL configured
8. Application Insights integrated for monitoring

---

## Tasks / Subtasks

### Task 1: Write Infrastructure Tests (TDD) (AC: 1, 2, 6)
- [ ] Create `production/app_service_test.go`
  - [ ] Test App Service creation
  - [ ] Test Managed Identity enabled
  - [ ] Test private endpoint configured
  - [ ] Test scaling rules active
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Create App Service Infrastructure (AC: 1, 4)
- [ ] Define App Service Plan
  ```hcl
  resource "azurerm_service_plan" "saas" {
    name                = "asp-oversight-prod"
    location            = var.location
    resource_group_name = "rg-oversight-prod-saas-eastus"
    os_type            = "Linux"
    sku_name           = "S2"
    
    # Enable zone redundancy for HA
    zone_balancing_enabled = true
    
    tags = {
      environment = "production"
      component   = "saas-app"
      managedBy   = "terraform"
    }
  }
  
  resource "azurerm_linux_web_app" "saas" {
    name                = "app-oversight-saas-prod"
    location            = var.location
    resource_group_name = "rg-oversight-prod-saas-eastus"
    service_plan_id     = azurerm_service_plan.saas.id
    
    site_config {
      always_on              = true
      http2_enabled         = true
      minimum_tls_version   = "1.2"
      ftps_state           = "Disabled"
      health_check_path    = "/health"
      
      application_stack {
        node_version = "18-lts"
      }
      
      cors {
        allowed_origins = ["https://app.oversight.com"]
        support_credentials = true
      }
      
      ip_restriction {
        name       = "Allow-AppGateway"
        priority   = 100
        action     = "Allow"
        service_tag = "ApplicationGateway"
      }
    }
    
    app_settings = {
      "NODE_ENV"                = "production"
      "WEBSITES_PORT"          = "3000"
      "WEBSITE_RUN_FROM_PACKAGE" = "1"
      "SAAS_CODEBASE_PATH"     = "/home/jez/code/SaaS"
      "APPLICATIONINSIGHTS_CONNECTION_STRING" = azurerm_application_insights.saas.connection_string
    }
    
    identity {
      type = "SystemAssigned"
    }
    
    logs {
      application_logs {
        file_system_level = "Information"
        azure_blob_storage {
          level             = "Information"
          retention_in_days = 30
          sas_url          = data.azurerm_storage_account_blob_container_sas.logs.sas
        }
      }
      
      http_logs {
        azure_blob_storage {
          retention_in_days = 7
          sas_url          = data.azurerm_storage_account_blob_container_sas.http_logs.sas
        }
      }
    }
  }
  ```
- [ ] Configure deployment slots
  ```hcl
  resource "azurerm_linux_web_app_slot" "staging" {
    name           = "staging"
    app_service_id = azurerm_linux_web_app.saas.id
    
    site_config {
      # Inherit from production
      always_on              = true
      http2_enabled         = true
      minimum_tls_version   = "1.2"
      health_check_path    = "/health"
      
      application_stack {
        node_version = "18-lts"
      }
    }
    
    app_settings = {
      "NODE_ENV" = "staging"
      "WEBSITES_PORT" = "3000"
    }
    
    identity {
      type = "SystemAssigned"
    }
  }
  ```
- [ ] Setup swap configuration
- [ ] Configure backup policy

### Task 3: Configure Managed Identity (AC: 2)
- [ ] Enable System Assigned Identity
  ```hcl
  # Already configured in web app resource above
  
  # Grant Key Vault access
  resource "azurerm_key_vault_access_policy" "app_service" {
    key_vault_id = azurerm_key_vault.main.id
    tenant_id    = data.azurerm_client_config.current.tenant_id
    object_id    = azurerm_linux_web_app.saas.identity[0].principal_id
    
    secret_permissions = [
      "Get",
      "List"
    ]
    
    certificate_permissions = [
      "Get",
      "List"
    ]
  }
  
  # Grant Storage access
  resource "azurerm_role_assignment" "app_service_storage" {
    scope                = azurerm_storage_account.main.id
    role_definition_name = "Storage Blob Data Contributor"
    principal_id         = azurerm_linux_web_app.saas.identity[0].principal_id
  }
  
  # Grant SQL Database access
  resource "azurerm_role_assignment" "app_service_sql" {
    scope                = azurerm_postgresql_flexible_server.main.id
    role_definition_name = "Contributor"
    principal_id         = azurerm_linux_web_app.saas.identity[0].principal_id
  }
  ```
- [ ] Configure application to use MI
  ```javascript
  // config/azure-identity.js
  const { DefaultAzureCredential } = require('@azure/identity');
  const { SecretClient } = require('@azure/keyvault-secrets');
  const { BlobServiceClient } = require('@azure/storage-blob');
  
  // Use Managed Identity
  const credential = new DefaultAzureCredential();
  
  // Access Key Vault
  const keyVaultUrl = process.env.KEY_VAULT_URL;
  const secretClient = new SecretClient(keyVaultUrl, credential);
  
  // Access Storage
  const storageAccount = process.env.STORAGE_ACCOUNT;
  const blobServiceClient = new BlobServiceClient(
    `https://${storageAccount}.blob.core.windows.net`,
    credential
  );
  
  module.exports = {
    credential,
    secretClient,
    blobServiceClient
  };
  ```
- [ ] Remove hardcoded credentials
- [ ] Test MI authentication

### Task 4: Setup Auto-scaling (AC: 3)
- [ ] Configure auto-scale rules
  ```hcl
  resource "azurerm_monitor_autoscale_setting" "saas" {
    name                = "autoscale-saas-prod"
    resource_group_name = "rg-oversight-prod-saas-eastus"
    location            = var.location
    target_resource_id  = azurerm_service_plan.saas.id
    
    profile {
      name = "defaultProfile"
      
      capacity {
        default = 2
        minimum = 2
        maximum = 10
      }
      
      # Scale up rule - CPU
      rule {
        metric_trigger {
          metric_name        = "CpuPercentage"
          metric_resource_id = azurerm_service_plan.saas.id
          time_grain        = "PT1M"
          statistic         = "Average"
          time_window       = "PT5M"
          time_aggregation  = "Average"
          operator          = "GreaterThan"
          threshold         = 70
        }
        
        scale_action {
          direction = "Increase"
          type      = "ChangeCount"
          value     = "1"
          cooldown  = "PT5M"
        }
      }
      
      # Scale down rule - CPU
      rule {
        metric_trigger {
          metric_name        = "CpuPercentage"
          metric_resource_id = azurerm_service_plan.saas.id
          time_grain        = "PT1M"
          statistic         = "Average"
          time_window       = "PT5M"
          time_aggregation  = "Average"
          operator          = "LessThan"
          threshold         = 25
        }
        
        scale_action {
          direction = "Decrease"
          type      = "ChangeCount"
          value     = "1"
          cooldown  = "PT10M"
        }
      }
      
      # Scale up rule - Memory
      rule {
        metric_trigger {
          metric_name        = "MemoryPercentage"
          metric_resource_id = azurerm_service_plan.saas.id
          time_grain        = "PT1M"
          statistic         = "Average"
          time_window       = "PT5M"
          time_aggregation  = "Average"
          operator          = "GreaterThan"
          threshold         = 80
        }
        
        scale_action {
          direction = "Increase"
          type      = "ChangeCount"
          value     = "1"
          cooldown  = "PT5M"
        }
      }
      
      # Scale up rule - HTTP Queue Length
      rule {
        metric_trigger {
          metric_name        = "HttpQueueLength"
          metric_resource_id = azurerm_service_plan.saas.id
          time_grain        = "PT1M"
          statistic         = "Average"
          time_window       = "PT5M"
          time_aggregation  = "Average"
          operator          = "GreaterThan"
          threshold         = 100
        }
        
        scale_action {
          direction = "Increase"
          type      = "ChangeCount"
          value     = "2"
          cooldown  = "PT5M"
        }
      }
    }
    
    notification {
      operation = "Scale"
      
      email {
        custom_emails = ["platform-team@oversight.com"]
      }
      
      webhook {
        service_uri = "https://alerts.oversight.com/webhook/scaling"
      }
    }
  }
  ```
- [ ] Configure predictive scaling
- [ ] Setup scale notifications
- [ ] Test scaling triggers

### Task 5: Integrate Existing Codebase (AC: 5)
- [ ] Configure deployment from `/home/jez/code/SaaS`
  ```yaml
  # azure-pipelines.yml
  trigger:
    branches:
      include:
        - main
    paths:
      include:
        - /home/jez/code/SaaS/*
  
  pool:
    vmImage: 'ubuntu-latest'
  
  stages:
    - stage: Build
      jobs:
        - job: BuildApp
          steps:
            - task: NodeTool@0
              inputs:
                versionSpec: '18.x'
            
            - script: |
                cd /home/jez/code/SaaS
                npm ci
                npm run build
                npm run test
              displayName: 'Build and test'
            
            - task: ArchiveFiles@2
              inputs:
                rootFolderOrFile: '/home/jez/code/SaaS'
                includeRootFolder: false
                archiveType: 'zip'
                archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
            
            - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
              artifact: drop
    
    - stage: Deploy
      jobs:
        - deployment: DeployToStaging
          environment: 'staging'
          strategy:
            runOnce:
              deploy:
                steps:
                  - task: AzureWebApp@1
                    inputs:
                      azureSubscription: 'Production'
                      appType: 'webAppLinux'
                      appName: 'app-oversight-saas-prod'
                      deployToSlotOrASE: true
                      slotName: 'staging'
                      package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
  ```
- [ ] Setup continuous deployment
- [ ] Configure build pipeline
- [ ] Test deployment process

### Task 6: Configure Private Endpoint (AC: 6)
- [ ] Create private endpoint
  ```hcl
  resource "azurerm_private_endpoint" "app_service" {
    name                = "pe-app-service"
    location            = var.location
    resource_group_name = "rg-oversight-prod-saas-eastus"
    subnet_id           = azurerm_subnet.saas_app.id
    
    private_service_connection {
      name                           = "psc-app-service"
      private_connection_resource_id = azurerm_linux_web_app.saas.id
      subresource_names             = ["sites"]
      is_manual_connection          = false
    }
    
    private_dns_zone_group {
      name                 = "pdz-group"
      private_dns_zone_ids = [azurerm_private_dns_zone.app_service.id]
    }
  }
  
  resource "azurerm_private_dns_zone" "app_service" {
    name                = "privatelink.azurewebsites.net"
    resource_group_name = "rg-oversight-prod-saas-eastus"
  }
  
  resource "azurerm_private_dns_zone_virtual_network_link" "app_service" {
    name                  = "pdz-link-app-service"
    resource_group_name   = "rg-oversight-prod-saas-eastus"
    private_dns_zone_name = azurerm_private_dns_zone.app_service.name
    virtual_network_id    = azurerm_virtual_network.main.id
  }
  ```
- [ ] Restrict public access
- [ ] Configure DNS resolution
- [ ] Test private connectivity

### Task 7: Setup Custom Domain and SSL (AC: 7)
- [ ] Configure custom domain
  ```hcl
  resource "azurerm_app_service_custom_hostname_binding" "saas" {
    hostname            = "app.oversight.com"
    app_service_name    = azurerm_linux_web_app.saas.name
    resource_group_name = "rg-oversight-prod-saas-eastus"
  }
  
  resource "azurerm_app_service_managed_certificate" "saas" {
    custom_hostname_binding_id = azurerm_app_service_custom_hostname_binding.saas.id
  }
  
  resource "azurerm_app_service_certificate_binding" "saas" {
    hostname_binding_id = azurerm_app_service_custom_hostname_binding.saas.id
    certificate_id      = azurerm_app_service_managed_certificate.saas.id
    ssl_state          = "SniEnabled"
  }
  ```
- [ ] Configure DNS records
- [ ] Setup certificate auto-renewal
- [ ] Force HTTPS redirect

### Task 8: Integrate Application Insights (AC: 8)
- [ ] Configure Application Insights
  ```hcl
  resource "azurerm_application_insights" "saas" {
    name                = "appi-oversight-saas"
    location            = var.location
    resource_group_name = "rg-oversight-prod-saas-eastus"
    application_type    = "Node.JS"
    retention_in_days   = 90
    
    daily_data_cap_in_gb = 10
    daily_data_cap_notifications_disabled = false
  }
  ```
- [ ] Add instrumentation to app
  ```javascript
  // app.js
  const appInsights = require('applicationinsights');
  
  appInsights.setup(process.env.APPLICATIONINSIGHTS_CONNECTION_STRING)
    .setAutoDependencyCorrelation(true)
    .setAutoCollectRequests(true)
    .setAutoCollectPerformance(true, true)
    .setAutoCollectExceptions(true)
    .setAutoCollectDependencies(true)
    .setAutoCollectConsole(true)
    .setUseDiskRetryCaching(true)
    .setSendLiveMetrics(true)
    .setDistributedTracingMode(appInsights.DistributedTracingModes.AI_AND_W3C)
    .start();
  
  // Custom telemetry
  const client = appInsights.defaultClient;
  client.trackEvent({
    name: 'AppStarted',
    properties: {
      environment: process.env.NODE_ENV,
      version: process.env.APP_VERSION
    }
  });
  ```
- [ ] Create custom metrics
- [ ] Setup alerts

---

## Dev Notes

### Deployment Configuration
```yaml
Production URL: https://app.oversight.com
Staging URL: https://app-oversight-saas-prod-staging.azurewebsites.net
SCM URL: https://app-oversight-saas-prod.scm.azurewebsites.net
Private IP: 10.20.2.10
```

### Environment Variables
```bash
NODE_ENV=production
WEBSITES_PORT=3000
KEY_VAULT_URL=https://kv-oversight-prod.vault.azure.net
STORAGE_ACCOUNT=stoversightprod
DATABASE_URL=Loaded from Key Vault
REDIS_URL=Loaded from Key Vault
```

### Testing Standards
- Test location: `/tests/production/`
- Test deployment to staging first
- Run smoke tests after deployment
- Monitor scaling behavior
- Verify MI authentication works

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_