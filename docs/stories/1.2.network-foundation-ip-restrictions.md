# Story 1.2: Create Network Foundation with IP Restrictions

**Epic:** 1 - Secure Access Infrastructure  
**Story Number:** 1.2  
**Title:** Network Foundation with IP Restrictions  
**Status:** READY  
**Points:** 5  
**Component:** 801 - IP Allowlist  

---

## Story

**As a** Security Administrator,  
**I want** to create a network foundation with strict IP allowlisting,  
**so that** only authorized sources can access our infrastructure.

---

## Acceptance Criteria

1. VNet created with address space 10.0.0.0/8 as per V8 architecture
2. All required subnets created according to V8 specification
3. Network Security Group (NSG) implements strict IP allowlist
4. Only GitHub webhooks, Azure DevOps, and admin IPs are allowed
5. Default deny-all rule is in place with lowest priority
6. Each allowed IP has a descriptive rule name
7. NSG is associated with appropriate subnets
8. All infrastructure tests pass before deployment
9. Terraform state is stored securely in Azure Storage

---

## Tasks / Subtasks

### Task 1: Write Infrastructure Tests First (TDD) (AC: 8)
- [ ] Create `network/vnet_test.go`
  - [ ] Test VNet creation with correct address space
  - [ ] Test all required subnets exist
  - [ ] Test subnet address ranges match V8 spec
- [ ] Create `network/nsg_test.go`  
  - [ ] Test NSG creation
  - [ ] Test allowed IP rules exist
  - [ ] Test default deny rule exists
  - [ ] Test rule priorities are correct
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Create Terraform Network Module (AC: 1, 2)
- [ ] Create `/terraform/modules/network/main.tf`
  - [ ] Define VNet resource with 10.0.0.0/8
  - [ ] Create all subnets per V8 architecture
- [ ] Create `/terraform/modules/network/variables.tf`
  - [ ] Define input variables for customization
  - [ ] Set default values where appropriate
- [ ] Create `/terraform/modules/network/outputs.tf`
  - [ ] Output VNet ID, name, and subnets

### Task 3: Implement IP Allowlist NSG (AC: 3, 4, 5, 6)
- [ ] Create `/terraform/modules/network/nsg.tf`
  - [ ] Define NSG resource
  - [ ] Add rule for GitHub Webhooks (140.82.112.0/20)
  - [ ] Add rule for GitHub Webhooks alt (143.55.64.0/20)
  - [ ] Add rule for Azure DevOps (13.107.6.0/24)
  - [ ] Add placeholder for admin IPs (variable)
  - [ ] Add default deny-all rule (priority 4096)
- [ ] Create security rule naming convention
  - [ ] Format: "Allow-{Source}-{Port}"

### Task 4: Associate NSG with Subnets (AC: 7)
- [ ] Update subnet definitions to include NSG association
  - [ ] Exclude AzureFirewallSubnet (has own rules)
  - [ ] Exclude AzureBastionSubnet (has specific requirements)
  - [ ] Apply to all application subnets
- [ ] Create subnet-specific NSGs where needed

### Task 5: Configure Terraform Backend (AC: 9)
- [ ] Create storage account for Terraform state
- [ ] Configure backend in `/terraform/environments/dev/backend.tf`
- [ ] Enable state locking with blob lease
- [ ] Configure encryption at rest

### Task 6: Run Tests and Deploy (AC: 8)
- [ ] Run infrastructure tests
  - [ ] All tests should pass (Green phase)
  - [ ] Generate test report
- [ ] Deploy to test resource group
- [ ] Validate deployment matches specifications
- [ ] Document any deviations or issues

---

## Dev Notes

### V8 Network Architecture Subnets

```hcl
# Subnet definitions per V8 architecture
subnets = {
  "AzureFirewallSubnet"  = "10.10.0.0/26"    # 811: Firewall
  "AzureBastionSubnet"   = "10.10.1.0/24"    # 812: Bastion  
  "subnet-saas-app"      = "10.20.2.0/24"    # 700: SaaS App
  "subnet-saas-db"       = "10.20.3.0/24"    # 711: PostgreSQL
  "subnet-saas-storage"  = "10.20.4.0/24"    # 712: Storage
  "subnet-saas-redis"    = "10.20.5.0/24"    # 713: Redis
  "subnet-saas-keyvault" = "10.20.6.0/24"    # 714: Key Vault
  "subnet-test-app"      = "10.40.1.0/24"    # 401: Test Container
  "subnet-dev-jenkins"   = "10.60.2.0/24"    # 301,501: Jenkins
  "subnet-dev-acr"       = "10.60.3.0/24"    # 308: ACR
  "subnet-monitoring"    = "10.90.1.0/24"    # 1001-1005: Monitoring
}
```

### IP Allowlist Rules (Component 801)

```hcl
# NSG Rules for IP Allowlist
security_rules = [
  {
    name                       = "Allow-GitHub-Webhooks-Primary"
    priority                   = 100
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_address_prefix      = "140.82.112.0/20"
    destination_port_ranges    = ["443", "80"]
  },
  {
    name                       = "Allow-GitHub-Webhooks-Secondary"  
    priority                   = 110
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_address_prefix      = "143.55.64.0/20"
    destination_port_ranges    = ["443", "80"]
  },
  {
    name                       = "Allow-AzureDevOps"
    priority                   = 120
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_address_prefix      = "13.107.6.0/24"
    destination_port_ranges    = ["443", "80"]
  },
  {
    name                       = "Deny-All"
    priority                   = 4096
    direction                  = "Inbound"
    access                     = "Deny"
    protocol                   = "*"
    source_address_prefix      = "*"
    destination_port_range     = "*"
  }
]
```

### Testing Standards
- Test files location: `/tests/infrastructure/network/`
- Use Terratest for infrastructure testing
- Each test should be idempotent
- Clean up test resources after completion

### Resource Naming Convention
- Resource Group: `rg-oversight-shared-network-eastus`
- VNet: `vnet-oversight-main`
- NSG: `nsg-oversight-allowlist`
- Subnets: As specified in V8 architecture

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_