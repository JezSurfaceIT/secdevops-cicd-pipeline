# Story 6.5: Integrate Azure Monitoring

**Epic:** 6 - Monitoring & Observability  
**Story Number:** 6.5  
**Title:** Connect Azure Monitor and Application Insights  
**Status:** READY  
**Points:** 3  
**Component:** 924 (Azure Monitor Integration)  

---

## Story

**As a** Cloud Engineer,  
**I want** native Azure monitoring integrated with our observability stack,  
**so that** we have complete visibility across Azure resources and custom applications.

---

## Acceptance Criteria

1. Azure Monitor data ingested into Prometheus
2. Application Insights configured for all applications
3. Log Analytics workspace integrated with Loki
4. Azure metrics available in Grafana
5. Cost monitoring and optimization alerts setup
6. Security Center integration enabled
7. Network Watcher configured
8. Diagnostic settings applied to all resources

---

## Tasks / Subtasks

### Task 1: Write Azure Monitor Tests (TDD) (AC: 1, 2, 4)
- [ ] Create `monitoring/azure_monitor_test.go`
  - [ ] Test metrics export
  - [ ] Test Application Insights
  - [ ] Test Log Analytics
  - [ ] Test cost alerts
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Configure Azure Monitor Export (AC: 1, 4)
- [ ] Setup Azure Monitor exporter
  ```yaml
  # azure-monitor-exporter/values.yaml
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: azure-monitor-exporter-config
    namespace: monitoring
  data:
    config.yaml: |
      credentials:
        subscription_id: ${AZURE_SUBSCRIPTION_ID}
        tenant_id: ${AZURE_TENANT_ID}
        client_id: ${AZURE_CLIENT_ID}
        client_secret: ${AZURE_CLIENT_SECRET}
      
      resource_groups:
        - name: rg-oversight-prod-saas-eastus
          resources:
            - Microsoft.Web/sites
            - Microsoft.Sql/servers
            - Microsoft.Cache/redis
            - Microsoft.Storage/storageAccounts
            - Microsoft.ContainerInstance/containerGroups
            - Microsoft.Network/applicationGateways
            - Microsoft.Network/loadBalancers
            - Microsoft.Compute/virtualMachines
      
      metrics:
        # App Services
        - name: app_service_cpu
          resource_type: Microsoft.Web/sites
          metric: CpuPercentage
          aggregation: Average
          interval: PT1M
        
        - name: app_service_memory
          resource_type: Microsoft.Web/sites
          metric: MemoryWorkingSet
          aggregation: Average
          interval: PT1M
        
        - name: app_service_requests
          resource_type: Microsoft.Web/sites
          metric: Requests
          aggregation: Total
          interval: PT1M
        
        - name: app_service_response_time
          resource_type: Microsoft.Web/sites
          metric: HttpResponseTime
          aggregation: Average
          interval: PT1M
        
        # PostgreSQL
        - name: postgres_cpu
          resource_type: Microsoft.DBforPostgreSQL/flexibleServers
          metric: cpu_percent
          aggregation: Average
          interval: PT5M
        
        - name: postgres_memory
          resource_type: Microsoft.DBforPostgreSQL/flexibleServers
          metric: memory_percent
          aggregation: Average
          interval: PT5M
        
        - name: postgres_connections
          resource_type: Microsoft.DBforPostgreSQL/flexibleServers
          metric: active_connections
          aggregation: Average
          interval: PT1M
        
        - name: postgres_storage
          resource_type: Microsoft.DBforPostgreSQL/flexibleServers
          metric: storage_percent
          aggregation: Average
          interval: PT5M
        
        # Redis Cache
        - name: redis_cache_hits
          resource_type: Microsoft.Cache/redis
          metric: cachehits
          aggregation: Total
          interval: PT1M
        
        - name: redis_cache_misses
          resource_type: Microsoft.Cache/redis
          metric: cachemisses
          aggregation: Total
          interval: PT1M
        
        - name: redis_connected_clients
          resource_type: Microsoft.Cache/redis
          metric: connectedclients
          aggregation: Maximum
          interval: PT1M
        
        # Storage Account
        - name: storage_used_capacity
          resource_type: Microsoft.Storage/storageAccounts
          metric: UsedCapacity
          aggregation: Average
          interval: PT1H
        
        - name: storage_transactions
          resource_type: Microsoft.Storage/storageAccounts
          metric: Transactions
          aggregation: Total
          interval: PT5M
          dimensions:
            - ResponseType
            - GeoType
        
        # Application Gateway
        - name: appgw_throughput
          resource_type: Microsoft.Network/applicationGateways
          metric: Throughput
          aggregation: Average
          interval: PT1M
        
        - name: appgw_failed_requests
          resource_type: Microsoft.Network/applicationGateways
          metric: FailedRequests
          aggregation: Total
          interval: PT1M
        
        - name: appgw_response_status
          resource_type: Microsoft.Network/applicationGateways
          metric: ResponseStatus
          aggregation: Total
          interval: PT1M
          dimensions:
            - HttpStatusGroup
  
  ---
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: azure-monitor-exporter
    namespace: monitoring
  spec:
    replicas: 2
    selector:
      matchLabels:
        app: azure-monitor-exporter
    template:
      metadata:
        labels:
          app: azure-monitor-exporter
      spec:
        containers:
        - name: exporter
          image: webdevops/azure-metrics-exporter:latest
          ports:
          - containerPort: 9090
          env:
          - name: AZURE_SUBSCRIPTION_ID
            valueFrom:
              secretKeyRef:
                name: azure-credentials
                key: subscription-id
          - name: AZURE_TENANT_ID
            valueFrom:
              secretKeyRef:
                name: azure-credentials
                key: tenant-id
          - name: AZURE_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: azure-credentials
                key: client-id
          - name: AZURE_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: azure-credentials
                key: client-secret
          volumeMounts:
          - name: config
            mountPath: /config
        volumes:
        - name: config
          configMap:
            name: azure-monitor-exporter-config
  ```
- [ ] Configure Prometheus scraping
  ```yaml
  # prometheus-azure-scrape.yaml
  - job_name: 'azure-monitor'
    scrape_interval: 60s
    static_configs:
      - targets: ['azure-monitor-exporter:9090']
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: azure-monitor-exporter:9090
  ```
- [ ] Setup metric mapping
- [ ] Test data ingestion

### Task 3: Setup Application Insights (AC: 2)
- [ ] Configure Application Insights
  ```javascript
  // config/app-insights.js
  const appInsights = require('applicationinsights');
  
  class ApplicationInsightsSetup {
    initialize() {
      // Setup Application Insights
      appInsights.setup(process.env.APPLICATIONINSIGHTS_CONNECTION_STRING)
        .setAutoDependencyCorrelation(true)
        .setAutoCollectRequests(true)
        .setAutoCollectPerformance(true, true)
        .setAutoCollectExceptions(true)
        .setAutoCollectDependencies(true)
        .setAutoCollectConsole(true, false)
        .setUseDiskRetryCaching(true)
        .setSendLiveMetrics(true)
        .setDistributedTracingMode(appInsights.DistributedTracingModes.AI_AND_W3C);
      
      // Custom configuration
      appInsights.defaultClient.context.tags[appInsights.defaultClient.context.keys.cloudRole] = 'oversight-api';
      appInsights.defaultClient.context.tags[appInsights.defaultClient.context.keys.cloudRoleInstance] = process.env.HOSTNAME;
      
      // Add custom properties to all telemetry
      appInsights.defaultClient.commonProperties = {
        environment: process.env.NODE_ENV,
        version: process.env.APP_VERSION,
        region: process.env.AZURE_REGION
      };
      
      // Configure sampling
      appInsights.defaultClient.config.samplingPercentage = 100; // 100% in prod for now
      
      // Custom telemetry processor
      appInsights.defaultClient.addTelemetryProcessor(this.telemetryProcessor);
      
      appInsights.start();
      
      return appInsights;
    }
    
    telemetryProcessor(envelope, context) {
      // Filter out health checks
      if (envelope.data.baseData?.url?.includes('/health')) {
        return false;
      }
      
      // Add custom dimensions
      if (envelope.data.baseType === 'RequestData') {
        envelope.data.baseData.properties = envelope.data.baseData.properties || {};
        envelope.data.baseData.properties.customProperty = 'customValue';
      }
      
      // Track slow requests
      if (envelope.data.baseType === 'RequestData' && 
          envelope.data.baseData.duration > 1000) {
        const client = appInsights.defaultClient;
        client.trackEvent({
          name: 'SlowRequest',
          properties: {
            url: envelope.data.baseData.url,
            duration: envelope.data.baseData.duration,
            resultCode: envelope.data.baseData.responseCode
          }
        });
      }
      
      return true;
    }
    
    // Custom tracking methods
    trackBusinessEvent(name, properties = {}, measurements = {}) {
      appInsights.defaultClient.trackEvent({
        name,
        properties: {
          ...properties,
          timestamp: new Date().toISOString()
        },
        measurements
      });
    }
    
    trackDependency(name, data, duration, success, resultCode) {
      appInsights.defaultClient.trackDependency({
        target: name,
        data,
        duration,
        success,
        resultCode,
        time: new Date()
      });
    }
    
    trackException(error, properties = {}) {
      appInsights.defaultClient.trackException({
        exception: error,
        properties: {
          ...properties,
          stack: error.stack,
          message: error.message
        }
      });
    }
  }
  
  module.exports = new ApplicationInsightsSetup();
  ```
- [ ] Setup distributed tracing
  ```javascript
  // middleware/tracing.js
  const { DistributedTracingModes } = require('applicationinsights');
  
  class TracingMiddleware {
    constructor(appInsights) {
      this.appInsights = appInsights;
    }
    
    middleware() {
      return (req, res, next) => {
        // Create request telemetry
        const requestTelemetry = this.appInsights.startOperation(req, res);
        
        // Add custom properties
        requestTelemetry.tagOverrides = {
          'ai.operation.id': req.headers['x-correlation-id'] || requestTelemetry.tagOverrides['ai.operation.id'],
          'ai.user.id': req.user?.id,
          'ai.session.id': req.session?.id
        };
        
        // Track custom dimensions
        req.trackEvent = (name, properties = {}) => {
          this.appInsights.defaultClient.trackEvent({
            name,
            properties: {
              ...properties,
              correlationId: requestTelemetry.tagOverrides['ai.operation.id']
            }
          });
        };
        
        req.trackMetric = (name, value) => {
          this.appInsights.defaultClient.trackMetric({
            name,
            value,
            properties: {
              correlationId: requestTelemetry.tagOverrides['ai.operation.id']
            }
          });
        };
        
        // Handle response
        const originalEnd = res.end;
        res.end = function(...args) {
          if (res.statusCode >= 400) {
            req.trackEvent('RequestError', {
              statusCode: res.statusCode,
              path: req.path,
              method: req.method
            });
          }
          
          originalEnd.apply(res, args);
        };
        
        next();
      };
    }
  }
  ```
- [ ] Configure availability tests
- [ ] Setup custom metrics

### Task 4: Integrate Log Analytics (AC: 3)
- [ ] Setup Log Analytics export
  ```hcl
  resource "azurerm_log_analytics_workspace" "main" {
    name                = "log-oversight-prod"
    location            = var.location
    resource_group_name = azurerm_resource_group.monitoring.name
    sku                = "PerGB2018"
    retention_in_days   = 90
    
    daily_quota_gb = 10
  }
  
  resource "azurerm_log_analytics_data_export_rule" "to_eventhub" {
    name                    = "export-to-eventhub"
    resource_group_name     = azurerm_resource_group.monitoring.name
    workspace_resource_id   = azurerm_log_analytics_workspace.main.id
    destination_resource_id = azurerm_eventhub_namespace.logs.id
    
    table_names = [
      "AppPerformanceCounters",
      "AppMetrics",
      "AppDependencies",
      "AppExceptions",
      "AppTraces",
      "AppRequests",
      "AzureActivity",
      "AzureDiagnostics",
      "ContainerLog",
      "KubeEvents"
    ]
    
    enabled = true
  }
  
  resource "azurerm_eventhub_namespace" "logs" {
    name                = "eh-oversight-logs"
    location            = var.location
    resource_group_name = azurerm_resource_group.monitoring.name
    sku                = "Standard"
    capacity           = 2
    
    auto_inflate_enabled     = true
    maximum_throughput_units = 10
  }
  
  resource "azurerm_eventhub" "logs" {
    name                = "logs-stream"
    namespace_name      = azurerm_eventhub_namespace.logs.name
    resource_group_name = azurerm_resource_group.monitoring.name
    partition_count     = 4
    message_retention   = 7
  }
  ```
- [ ] Configure Fluent Bit for Log Analytics
  ```yaml
  # fluent-bit-la-output.yaml
  [OUTPUT]
      Name azure_kusto
      Match kube.*
      Tenant_Id ${AZURE_TENANT_ID}
      Client_Id ${AZURE_CLIENT_ID}
      Client_Secret ${AZURE_CLIENT_SECRET}
      Ingestion_Endpoint https://log-oversight-prod.ods.opinsights.azure.com
      Database_Name ${LOG_ANALYTICS_WORKSPACE_ID}
      Table_Name ContainerLog
      Ingestion_Mapping_Reference container_log_mapping
  
  [OUTPUT]
      Name azure_blob
      Match app.*
      account_name ${STORAGE_ACCOUNT}
      shared_key ${STORAGE_KEY}
      path logs
      container_name applogs
      auto_create_container on
      blob_type blockblob
      compress gzip
      emitter_mem_buf_limit 10M
  ```
- [ ] Setup KQL queries
  ```kusto
  // Common KQL queries for Log Analytics
  
  // Application errors last hour
  AppExceptions
  | where TimeGenerated > ago(1h)
  | summarize Count = count() by ExceptionType, OuterMessage
  | order by Count desc
  
  // Slow requests
  AppRequests
  | where TimeGenerated > ago(1h)
  | where DurationMs > 1000
  | project TimeGenerated, Name, DurationMs, ResultCode
  | order by DurationMs desc
  
  // Failed dependencies
  AppDependencies
  | where TimeGenerated > ago(1h)
  | where Success == false
  | summarize FailureCount = count() by Target, DependencyType
  | order by FailureCount desc
  
  // Container resource usage
  ContainerInventory
  | where TimeGenerated > ago(5m)
  | summarize 
      AvgCPU = avg(CPUUsageNanoCores)/1000000,
      AvgMemory = avg(MemoryWorkingSetBytes)/1024/1024
    by ContainerName, Namespace
  | order by AvgCPU desc
  ```
- [ ] Create log forwarding

### Task 5: Setup Cost Monitoring (AC: 5)
- [ ] Configure cost alerts
  ```hcl
  resource "azurerm_consumption_budget_subscription" "monthly" {
    name            = "budget-monthly"
    subscription_id = data.azurerm_subscription.current.id
    
    amount     = 10000
    time_grain = "Monthly"
    
    time_period {
      start_date = "2024-01-01T00:00:00Z"
    }
    
    notification {
      enabled        = true
      threshold      = 80.0
      operator       = "GreaterThan"
      threshold_type = "Forecasted"
      
      contact_emails = [
        "finance@oversight.com",
        "devops@oversight.com"
      ]
      
      contact_roles = [
        "Owner",
        "Contributor"
      ]
    }
    
    notification {
      enabled        = true
      threshold      = 90.0
      operator       = "GreaterThan"
      
      contact_emails = [
        "cto@oversight.com"
      ]
    }
    
    notification {
      enabled        = true
      threshold      = 100.0
      operator       = "GreaterThanOrEqualTo"
      
      contact_emails = [
        "emergency@oversight.com"
      ]
    }
  }
  
  resource "azurerm_monitor_action_group" "cost_alerts" {
    name                = "ag-cost-alerts"
    resource_group_name = azurerm_resource_group.monitoring.name
    short_name          = "cost"
    
    email_receiver {
      name          = "finance"
      email_address = "finance@oversight.com"
    }
    
    webhook_receiver {
      name        = "slack"
      service_uri = var.slack_webhook_url
    }
    
    logic_app_receiver {
      name                    = "cost_automation"
      resource_id            = azurerm_logic_app_workflow.cost_optimization.id
      callback_url           = azurerm_logic_app_workflow.cost_optimization.access_endpoint
      use_common_alert_schema = true
    }
  }
  ```
- [ ] Create cost optimization rules
  ```javascript
  // services/cost-optimizer.js
  class CostOptimizer {
    async analyzeCosts() {
      const costs = await this.getCostData();
      const recommendations = [];
      
      // Analyze VM usage
      const vmCosts = costs.filter(c => c.resourceType === 'VirtualMachine');
      for (const vm of vmCosts) {
        if (vm.avgCpuUsage < 10 && vm.monthlyCost > 100) {
          recommendations.push({
            type: 'DOWNSIZE_VM',
            resource: vm.resourceId,
            currentSize: vm.size,
            recommendedSize: this.getRecommendedSize(vm),
            potentialSavings: vm.monthlyCost * 0.5
          });
        }
      }
      
      // Analyze storage
      const storageCosts = costs.filter(c => c.resourceType === 'StorageAccount');
      for (const storage of storageCosts) {
        if (storage.lastAccessDays > 90) {
          recommendations.push({
            type: 'ARCHIVE_STORAGE',
            resource: storage.resourceId,
            currentTier: storage.tier,
            recommendedTier: 'Archive',
            potentialSavings: storage.monthlyCost * 0.7
          });
        }
      }
      
      // Analyze databases
      const dbCosts = costs.filter(c => c.resourceType === 'SQLDatabase');
      for (const db of dbCosts) {
        if (db.avgDtuUsage < 20) {
          recommendations.push({
            type: 'SWITCH_TO_SERVERLESS',
            resource: db.resourceId,
            currentSku: db.sku,
            recommendedSku: 'Serverless',
            potentialSavings: db.monthlyCost * 0.6
          });
        }
      }
      
      return recommendations;
    }
    
    async implementRecommendation(recommendation) {
      switch (recommendation.type) {
        case 'DOWNSIZE_VM':
          await this.resizeVM(
            recommendation.resource, 
            recommendation.recommendedSize
          );
          break;
          
        case 'ARCHIVE_STORAGE':
          await this.changeStorageTier(
            recommendation.resource,
            'Archive'
          );
          break;
          
        case 'SWITCH_TO_SERVERLESS':
          // Requires manual intervention
          await this.createChangeRequest(recommendation);
          break;
      }
    }
  }
  ```
- [ ] Setup spending reports
- [ ] Configure budget enforcement

### Task 6: Enable Security Center (AC: 6)
- [ ] Configure Security Center
  ```hcl
  resource "azurerm_security_center_subscription_pricing" "defender" {
    tier          = "Standard"
    resource_type = "VirtualMachines"
  }
  
  resource "azurerm_security_center_contact" "main" {
    email               = "security@oversight.com"
    phone               = "+1234567890"
    alert_notifications = true
    alerts_to_admins    = true
  }
  
  resource "azurerm_security_center_setting" "mcas" {
    setting_name = "MCAS"
    enabled      = true
  }
  
  resource "azurerm_security_center_auto_provisioning" "la_agent" {
    auto_provision = "On"
  }
  
  resource "azurerm_security_center_workspace" "main" {
    scope        = "/subscriptions/${data.azurerm_subscription.current.subscription_id}"
    workspace_id = azurerm_log_analytics_workspace.main.id
  }
  
  resource "azurerm_monitor_alert_rule" "security_alert" {
    name                = "security-critical-alert"
    resource_group_name = azurerm_resource_group.monitoring.name
    location            = var.location
    
    data_source_id = azurerm_log_analytics_workspace.main.id
    
    criteria {
      metric_namespace = "Microsoft.Security"
      metric_name      = "SecurityAlert"
      aggregation      = "Count"
      operator         = "GreaterThan"
      threshold        = 0
      
      dimension {
        name     = "Severity"
        operator = "Include"
        values   = ["High", "Critical"]
      }
    }
    
    action {
      action_group_id = azurerm_monitor_action_group.security.id
    }
  }
  ```
- [ ] Setup security automation
  ```javascript
  // services/security-automation.js
  class SecurityAutomation {
    async handleSecurityAlert(alert) {
      const severity = alert.properties.severity;
      const tactics = alert.properties.tactics || [];
      
      // Auto-remediation for known issues
      if (alert.properties.alertType === 'VM_SuspiciousActivity') {
        await this.isolateVM(alert.properties.resourceId);
        await this.createIncident(alert);
      }
      
      if (tactics.includes('CredentialAccess')) {
        await this.resetCredentials(alert.properties.compromisedEntity);
        await this.enforceMAF(alert.properties.compromisedEntity);
      }
      
      if (tactics.includes('Exfiltration')) {
        await this.blockNetworkEgress(alert.properties.resourceId);
        await this.snapshotForensics(alert.properties.resourceId);
      }
      
      // Always notify security team
      await this.notifySecurityTeam(alert);
      
      // Create automated response report
      return {
        alertId: alert.id,
        actions_taken: this.actionLog,
        timestamp: new Date(),
        status: 'contained'
      };
    }
  }
  ```
- [ ] Configure compliance policies
- [ ] Setup vulnerability scanning

### Task 7: Setup Network Watcher (AC: 7)
- [ ] Configure Network Watcher
  ```hcl
  resource "azurerm_network_watcher" "main" {
    name                = "nw-oversight-${var.location}"
    location            = var.location
    resource_group_name = azurerm_resource_group.monitoring.name
  }
  
  resource "azurerm_network_watcher_flow_log" "main" {
    network_watcher_name = azurerm_network_watcher.main.name
    resource_group_name  = azurerm_resource_group.monitoring.name
    
    network_security_group_id = azurerm_network_security_group.main.id
    storage_account_id        = azurerm_storage_account.logs.id
    enabled                   = true
    version                   = 2
    
    retention_policy {
      enabled = true
      days    = 30
    }
    
    traffic_analytics {
      enabled               = true
      workspace_id         = azurerm_log_analytics_workspace.main.workspace_id
      workspace_region     = var.location
      workspace_resource_id = azurerm_log_analytics_workspace.main.id
      interval_in_minutes  = 10
    }
  }
  
  resource "azurerm_network_connection_monitor" "main" {
    name               = "cm-oversight"
    network_watcher_id = azurerm_network_watcher.main.id
    location          = var.location
    
    endpoint {
      name               = "webapp"
      target_resource_id = azurerm_app_service.main.id
    }
    
    endpoint {
      name    = "external"
      address = "oversight.com"
    }
    
    test_configuration {
      name                      = "http_test"
      protocol                  = "Http"
      http_configuration {
        method                   = "GET"
        port                     = 443
        prefer_https            = true
        valid_status_code_ranges = ["200-202", "301-302"]
      }
      test_frequency_in_seconds = 60
    }
    
    test_group {
      name                     = "webapp_connectivity"
      destination_endpoints    = ["external"]
      source_endpoints        = ["webapp"]
      test_configuration_names = ["http_test"]
    }
  }
  ```
- [ ] Setup packet capture
- [ ] Configure connection monitoring
- [ ] Create network diagnostics

### Task 8: Apply Diagnostic Settings (AC: 8)
- [ ] Configure resource diagnostics
  ```hcl
  # Diagnostic settings for all resources
  locals {
    diagnostic_resources = {
      app_service = azurerm_app_service.main.id
      postgresql  = azurerm_postgresql_flexible_server.main.id
      redis      = azurerm_redis_cache.main.id
      key_vault  = azurerm_key_vault.main.id
      app_gateway = azurerm_application_gateway.main.id
      storage    = "${azurerm_storage_account.main.id}/blobServices/default"
    }
  }
  
  resource "azurerm_monitor_diagnostic_setting" "resources" {
    for_each = local.diagnostic_resources
    
    name               = "diag-${each.key}"
    target_resource_id = each.value
    
    log_analytics_workspace_id     = azurerm_log_analytics_workspace.main.id
    eventhub_authorization_rule_id = azurerm_eventhub_namespace_authorization_rule.logs.id
    eventhub_name                 = azurerm_eventhub.logs.name
    
    dynamic "enabled_log" {
      for_each = data.azurerm_monitor_diagnostic_categories.main[each.key].logs
      content {
        category = enabled_log.value
        
        retention_policy {
          enabled = true
          days    = 30
        }
      }
    }
    
    dynamic "metric" {
      for_each = data.azurerm_monitor_diagnostic_categories.main[each.key].metrics
      content {
        category = metric.value
        
        retention_policy {
          enabled = true
          days    = 30
        }
      }
    }
  }
  ```
- [ ] Setup activity log export
- [ ] Configure metric alerts
- [ ] Create diagnostic queries

---

## Dev Notes

### Azure Monitor Integration Points
```
Prometheus Endpoint: http://azure-monitor-exporter:9090
Application Insights: InstrumentationKey in Key Vault
Log Analytics: Workspace ID in environment
Cost Management API: https://management.azure.com/
```

### Metric Namespaces
```
Microsoft.Web/sites
Microsoft.Sql/servers
Microsoft.Cache/redis
Microsoft.Storage/storageAccounts
Microsoft.Network/applicationGateways
Microsoft.Compute/virtualMachines
```

### Cost Optimization Thresholds
- VM CPU < 10% for 7 days → Downsize
- Storage not accessed > 90 days → Archive
- Database DTU < 20% → Consider serverless
- Unattached disks > 30 days → Delete

### Security Alert Priorities
1. Critical + CredentialAccess → Immediate response
2. High + Exfiltration → Network isolation
3. Medium + Anomaly → Investigation
4. Low → Logged for review

### Testing Standards
- Test location: `/tests/monitoring/azure/`
- Test metric collection
- Verify cost alerts
- Test security automation
- Validate log forwarding

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_