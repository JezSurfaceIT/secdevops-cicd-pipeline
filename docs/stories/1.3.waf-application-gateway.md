# Story 1.3: Deploy WAF and Application Gateway

**Epic:** 1 - Secure Access Infrastructure  
**Story Number:** 1.3  
**Title:** Configure WAF and Application Gateway  
**Status:** READY  
**Points:** 5  
**Components:** 802 (WAF), 803 (Application Gateway)  

---

## Story

**As a** Security Engineer,  
**I want** to deploy a Web Application Firewall with Application Gateway,  
**so that** all incoming traffic is inspected and protected against OWASP Top 10 threats.

---

## Acceptance Criteria

1. WAF Policy created with OWASP 3.2 ruleset enabled
2. Application Gateway deployed with WAF_v2 SKU
3. Public IP (172.178.53.198) is the ONLY public endpoint
4. SSL/TLS termination configured with proper certificates
5. Backend pools configured to route to internal resources
6. Health probes configured for backend services
7. Custom error pages for blocked requests
8. All infrastructure tests pass before deployment
9. WAF logs are sent to Log Analytics

---

## Tasks / Subtasks

### Task 1: Write Infrastructure Tests First (TDD) (AC: 8)
- [ ] Create `security/waf_test.go`
  - [ ] Test WAF policy creation
  - [ ] Test OWASP ruleset is enabled
  - [ ] Test custom rules if any
  - [ ] Test exclusion rules if needed
- [ ] Create `security/appgateway_test.go`
  - [ ] Test Application Gateway creation
  - [ ] Test WAF is associated
  - [ ] Test backend pools configuration
  - [ ] Test routing rules
  - [ ] Test public IP association
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Create WAF Policy Module (AC: 1)
- [ ] Create `/terraform/modules/waf/main.tf`
  - [ ] Define WAF policy resource
  - [ ] Enable OWASP 3.2 ruleset
  - [ ] Set mode to "Prevention" not "Detection"
  - [ ] Configure managed rule sets
- [ ] Create custom rules for specific threats
  - [ ] Rate limiting rules
  - [ ] Geo-blocking if needed
  - [ ] Custom threat patterns
- [ ] Configure exclusions for legitimate traffic

### Task 3: Deploy Application Gateway (AC: 2, 3, 5)
- [ ] Create `/terraform/modules/appgateway/main.tf`
  - [ ] Define Application Gateway with WAF_v2 SKU
  - [ ] Configure minimum 2 instances for HA
  - [ ] Set up autoscaling rules
- [ ] Configure frontend IP configuration
  - [ ] Create/reference public IP
  - [ ] Ensure it's the ONLY public IP in the system
- [ ] Configure backend pools
  - [ ] Pool for test application (10.40.1.0/24)
  - [ ] Pool for future services

### Task 4: Configure SSL/TLS (AC: 4)
- [ ] Generate or import SSL certificates
  - [ ] Store in Key Vault
  - [ ] Reference from Application Gateway
- [ ] Configure HTTPS listeners
  - [ ] Port 443 with certificate
  - [ ] HTTP to HTTPS redirect on port 80
- [ ] Set up SSL policy
  - [ ] Minimum TLS 1.2
  - [ ] Strong cipher suites only

### Task 5: Setup Health Monitoring (AC: 6, 9)
- [ ] Configure health probes
  - [ ] HTTP/HTTPS probes for each backend
  - [ ] Custom probe paths
  - [ ] Timeout and threshold settings
- [ ] Configure WAF logging
  - [ ] Create Log Analytics workspace if not exists
  - [ ] Enable diagnostic settings
  - [ ] Configure log retention
- [ ] Set up alerts
  - [ ] Alert on blocked requests spike
  - [ ] Alert on backend health issues

### Task 6: Create Custom Error Pages (AC: 7)
- [ ] Design custom 403 Forbidden page
- [ ] Design custom 502 Bad Gateway page  
- [ ] Upload to storage account
- [ ] Configure Application Gateway custom error pages
- [ ] Test error page display

### Task 7: Run Tests and Deploy (AC: 8)
- [ ] Run all infrastructure tests
  - [ ] WAF tests should pass
  - [ ] Application Gateway tests should pass
- [ ] Deploy to test environment
- [ ] Run security validation
  - [ ] Test OWASP attacks are blocked
  - [ ] Test legitimate traffic passes
- [ ] Document configuration

---

## Dev Notes

### WAF Configuration Example

```hcl
resource "azurerm_web_application_firewall_policy" "main" {
  name                = "waf-oversight-main"
  resource_group_name = var.resource_group_name
  location            = var.location

  policy_settings {
    enabled                     = true
    mode                       = "Prevention"
    request_body_check         = true
    file_upload_limit_in_mb   = 100
    max_request_body_size_in_kb = 128
  }

  managed_rules {
    managed_rule_set {
      type    = "OWASP"
      version = "3.2"
      
      rule_group_override {
        rule_group_name = "REQUEST-920-PROTOCOL-ENFORCEMENT"
        disabled_rules  = []
      }
    }
  }

  custom_rules {
    name      = "RateLimitRule"
    priority  = 1
    rule_type = "RateLimiting"
    
    match_conditions {
      match_variables {
        variable_name = "RemoteAddr"
      }
      operator           = "IPMatch"
      negation_condition = false
      match_values       = ["10.0.0.0/8"]
    }
    
    action = "Block"
  }
}
```

### Application Gateway Backend Configuration

```hcl
backend_address_pool {
  name         = "pool-test-app"
  ip_addresses = ["10.40.1.10", "10.40.1.11"]  # Test app IPs
}

backend_http_settings {
  name                  = "http-settings-default"
  cookie_based_affinity = "Disabled"
  port                  = 80
  protocol              = "Http"
  request_timeout       = 60
  probe_name           = "health-probe-default"
}

probe {
  name                = "health-probe-default"
  protocol            = "Http"
  path                = "/health"
  interval            = 30
  timeout             = 30
  unhealthy_threshold = 3
}
```

### Testing Standards
- Test location: `/tests/infrastructure/security/`
- Validate WAF blocks OWASP attacks
- Validate routing rules work correctly
- Test SSL/TLS configuration
- Ensure only one public IP exists

### Log Analytics Query Examples

```kusto
// WAF blocked requests
AzureDiagnostics
| where ResourceType == "APPLICATIONGATEWAYS"
| where OperationName == "ApplicationGatewayFirewall"
| where action_s == "Blocked"
| summarize count() by ruleName_s, bin(TimeGenerated, 5m)

// Backend health status
AzureDiagnostics
| where ResourceType == "APPLICATIONGATEWAYS"
| where OperationName == "ApplicationGatewayAccess"
| where httpStatus_d >= 500
| summarize count() by backendPoolName_s, bin(TimeGenerated, 5m)
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_