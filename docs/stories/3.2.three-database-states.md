# Story 3.2: Implement 3 Database States

**Epic:** 3 - Test Environment & Automation  
**Story Number:** 3.2  
**Title:** Create and Manage Three Database States  
**Status:** READY  
**Points:** 5  
**Components:** 411-413 (DB States)  

---

## Story

**As a** Test Engineer,  
**I want** three different database states for testing,  
**so that** I can test various scenarios from clean schema to full data.

---

## Acceptance Criteria

1. State 1: Schema only - clean database with tables (411)
2. State 2: Framework data - lookups and configuration (412)  
3. State 3: Full test data - complete dataset (413)
4. Quick switching between states (<30 seconds)
5. States stored as snapshots for consistency
6. Automated state validation after switch
7. State reset doesn't affect other services
8. Documentation of what each state contains

---

## Tasks / Subtasks

### Task 1: Write Database Tests (TDD) (AC: 1, 2, 3, 6)
- [ ] Create `database/state_test.go`
  - [ ] Test state 1 has schema only
  - [ ] Test state 2 has framework data
  - [ ] Test state 3 has full test data
  - [ ] Test state switching works
  - [ ] Test validation passes
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Create Database Infrastructure (AC: 1, 2, 3)
- [ ] Deploy PostgreSQL for test environment
  ```hcl
  resource "azurerm_postgresql_flexible_server" "test" {
    name                = "psql-test-oversight"
    location            = var.location
    resource_group_name = "rg-oversight-test-acs-eastus"
    
    administrator_login    = "testadmin"
    administrator_password = random_password.db_password.result
    
    sku_name   = "B_Standard_B2s"
    version    = "14"
    storage_mb = 32768
    
    backup_retention_days = 7
    geo_redundant_backup_enabled = false
  }
  
  # Create three databases
  resource "azurerm_postgresql_flexible_server_database" "states" {
    for_each = toset(["state1_schema", "state2_framework", "state3_fulldata"])
    
    name       = each.value
    server_id  = azurerm_postgresql_flexible_server.test.id
    charset    = "UTF8"
    collation  = "en_US.utf8"
  }
  ```
- [ ] Configure network access
- [ ] Setup connection pooling
- [ ] Create backup strategy

### Task 3: Setup State 1 - Schema Only (AC: 1)
- [ ] Create schema migration scripts
  ```sql
  -- migrations/001_initial_schema.sql
  CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );
  
  CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );
  
  CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id),
    name VARCHAR(255) NOT NULL,
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );
  
  -- Indexes
  CREATE INDEX idx_users_email ON users(email);
  CREATE INDEX idx_projects_org ON projects(organization_id);
  CREATE INDEX idx_projects_status ON projects(status);
  ```
- [ ] Run migrations
- [ ] Verify schema created
- [ ] Create snapshot

### Task 4: Setup State 2 - Framework Data (AC: 2)
- [ ] Create framework data scripts
  ```sql
  -- seed/framework_data.sql
  
  -- System users
  INSERT INTO users (email, name) VALUES
    ('admin@system.local', 'System Admin'),
    ('test@system.local', 'Test User'),
    ('service@system.local', 'Service Account');
  
  -- Default organization
  INSERT INTO organizations (name, slug) VALUES
    ('Test Organization', 'test-org'),
    ('Demo Organization', 'demo-org');
  
  -- Lookup tables
  CREATE TABLE status_types (
    code VARCHAR(50) PRIMARY KEY,
    description VARCHAR(255)
  );
  
  INSERT INTO status_types VALUES
    ('active', 'Active status'),
    ('pending', 'Pending approval'),
    ('archived', 'Archived item');
  
  -- Configuration
  CREATE TABLE system_config (
    key VARCHAR(100) PRIMARY KEY,
    value TEXT,
    type VARCHAR(50)
  );
  
  INSERT INTO system_config VALUES
    ('feature.new_ui', 'true', 'boolean'),
    ('limits.max_projects', '100', 'integer'),
    ('defaults.timezone', 'UTC', 'string');
  ```
- [ ] Apply framework data
- [ ] Validate data integrity
- [ ] Create snapshot

### Task 5: Setup State 3 - Full Test Data (AC: 3)
- [ ] Generate comprehensive test data
  ```javascript
  // seed/generate-test-data.js
  const faker = require('faker');
  const { Client } = require('pg');
  
  async function generateTestData() {
    const client = new Client({
      connectionString: process.env.DATABASE_URL
    });
    
    await client.connect();
    
    // Generate users
    for (let i = 0; i < 1000; i++) {
      await client.query(
        'INSERT INTO users (email, name) VALUES ($1, $2)',
        [faker.internet.email(), faker.name.findName()]
      );
    }
    
    // Generate organizations
    for (let i = 0; i < 100; i++) {
      await client.query(
        'INSERT INTO organizations (name, slug) VALUES ($1, $2)',
        [faker.company.companyName(), faker.helpers.slugify(faker.company.companyName())]
      );
    }
    
    // Generate projects with relationships
    const orgs = await client.query('SELECT id FROM organizations');
    for (let i = 0; i < 500; i++) {
      const orgId = orgs.rows[Math.floor(Math.random() * orgs.rows.length)].id;
      await client.query(
        'INSERT INTO projects (organization_id, name, status) VALUES ($1, $2, $3)',
        [orgId, faker.commerce.productName(), faker.random.arrayElement(['active', 'pending', 'archived'])]
      );
    }
    
    await client.end();
  }
  ```
- [ ] Load test data
- [ ] Create performance test data
- [ ] Create edge case data
- [ ] Create snapshot

### Task 6: Implement State Switching (AC: 4, 5)
- [ ] Create state management script
  ```bash
  #!/bin/bash
  # switch-db-state.sh
  
  STATE=$1
  DB_SERVER="psql-test-oversight.postgres.database.azure.com"
  ADMIN_USER="testadmin@psql-test-oversight"
  
  case $STATE in
    1)
      echo "Switching to State 1: Schema Only"
      DATABASE="state1_schema"
      ;;
    2)
      echo "Switching to State 2: Framework Data"
      DATABASE="state2_framework"
      ;;
    3)
      echo "Switching to State 3: Full Test Data"
      DATABASE="state3_fulldata"
      ;;
    *)
      echo "Invalid state. Use 1, 2, or 3"
      exit 1
      ;;
  esac
  
  # Update application connection
  export DATABASE_URL="postgresql://${ADMIN_USER}:${DB_PASSWORD}@${DB_SERVER}:5432/${DATABASE}?sslmode=require"
  
  # Update Vault with new connection
  vault kv put secret/test/database \
    url="${DATABASE_URL}" \
    state="${STATE}"
  
  # Restart application to use new database
  az container restart --name aci-test-environment \
    --resource-group rg-oversight-test-acs-eastus
  
  # Wait for healthy state
  ./wait-for-health.sh
  
  echo "Switched to database state ${STATE}"
  ```
- [ ] Optimize switching speed
- [ ] Create state backup
- [ ] Setup rollback capability

### Task 7: Create State Validation (AC: 6)
- [ ] Implement validation checks
  ```javascript
  // validate-db-state.js
  async function validateDatabaseState(state) {
    const validations = {
      1: validateSchemaOnly,
      2: validateFrameworkData,
      3: validateFullData
    };
    
    const validator = validations[state];
    if (!validator) {
      throw new Error(`Invalid state: ${state}`);
    }
    
    return await validator();
  }
  
  async function validateSchemaOnly() {
    const checks = [];
    
    // Check tables exist
    const tables = await db.query(`
      SELECT table_name FROM information_schema.tables 
      WHERE table_schema = 'public'
    `);
    checks.push({
      name: 'Tables exist',
      passed: tables.rows.length > 0
    });
    
    // Check no data in tables
    const counts = await Promise.all([
      db.query('SELECT COUNT(*) FROM users'),
      db.query('SELECT COUNT(*) FROM organizations'),
      db.query('SELECT COUNT(*) FROM projects')
    ]);
    
    checks.push({
      name: 'No data in tables',
      passed: counts.every(r => r.rows[0].count === '0')
    });
    
    return {
      state: 1,
      valid: checks.every(c => c.passed),
      checks
    };
  }
  
  async function validateFrameworkData() {
    const checks = [];
    
    // Check system users exist
    const users = await db.query(`
      SELECT COUNT(*) FROM users 
      WHERE email LIKE '%@system.local'
    `);
    checks.push({
      name: 'System users exist',
      passed: users.rows[0].count >= 3
    });
    
    // Check lookup tables populated
    const lookups = await db.query('SELECT COUNT(*) FROM status_types');
    checks.push({
      name: 'Lookup tables populated',
      passed: lookups.rows[0].count > 0
    });
    
    return {
      state: 2,
      valid: checks.every(c => c.passed),
      checks
    };
  }
  
  async function validateFullData() {
    const checks = [];
    
    // Check data volumes
    const volumes = await db.query(`
      SELECT 
        (SELECT COUNT(*) FROM users) as users,
        (SELECT COUNT(*) FROM organizations) as orgs,
        (SELECT COUNT(*) FROM projects) as projects
    `);
    
    checks.push({
      name: 'Sufficient test data',
      passed: volumes.rows[0].users >= 1000 &&
              volumes.rows[0].orgs >= 100 &&
              volumes.rows[0].projects >= 500
    });
    
    return {
      state: 3,
      valid: checks.every(c => c.passed),
      checks
    };
  }
  ```
- [ ] Create validation API endpoint
- [ ] Setup automated validation
- [ ] Create validation reports

### Task 8: Document States (AC: 8)
- [ ] Create state documentation
- [ ] Document use cases for each state
- [ ] Create state comparison table
- [ ] Add troubleshooting guide

---

## Dev Notes

### Database State Snapshots
```bash
# Create snapshots
pg_dump -h $DB_SERVER -U $ADMIN_USER -d state1_schema > state1.sql
pg_dump -h $DB_SERVER -U $ADMIN_USER -d state2_framework > state2.sql  
pg_dump -h $DB_SERVER -U $ADMIN_USER -d state3_fulldata > state3.sql

# Store in Azure Storage
az storage blob upload --container-name db-snapshots \
  --file state1.sql --name state1-$(date +%Y%m%d).sql
```

### State Usage Guidelines
| State | Use Case | Data Volume | Reset Frequency |
|-------|----------|-------------|-----------------|
| State 1 | Schema testing, migrations | 0 records | After each test |
| State 2 | Integration tests, API tests | ~100 records | Daily |
| State 3 | Performance tests, E2E tests | ~2000 records | Weekly |

### Testing Standards
- Test location: `/tests/database/`
- Validate each state independently
- Test switching between states
- Verify no data leakage
- Check performance impact

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

---

## QA Results
_To be populated by QA agent_