# Story 7.1: Implement Environment Headers

**Epic:** 7 - Environment Visibility  
**Story Number:** 7.1  
**Title:** Configure WAF/Application Gateway Environment Headers  
**Status:** PLANNED  
**Points:** 3  
**Component:** 1101 (Environment Headers)  

---

## Story

**As a** Developer/Administrator,  
**I want** environment-specific headers automatically injected in all HTTP responses,  
**so that** I can immediately identify which environment I'm working with in browser developer tools.

---

## Acceptance Criteria

1. WAF/Application Gateway injects X-Environment header with environment name
2. X-Environment-Color header indicates visual color code for environment
3. X-Environment-Region header shows deployment region
4. X-Deployment-Version header shows current version number
5. Headers visible in browser developer tools (Chrome, Firefox, Edge, Safari)
6. Headers present in both successful and error responses
7. Headers added without modifying application code
8. Production headers configurable to minimize exposure

---

## Tasks / Subtasks

### Task 1: Write Tests for Header Injection (TDD)
- [ ] Create `tests/environment/header_injection_test.py`
  - [ ] Test WAF adds X-Environment header
  - [ ] Test color coding header matches environment
  - [ ] Test region header present
  - [ ] Test version header format
  - [ ] Test headers in error responses
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Configure WAF Policy Rules
- [ ] Update WAF policy with rewrite rules
  ```hcl
  # terraform/waf-policy.tf addition
  resource "azurerm_application_gateway_rewrite_rule_set" "environment_headers" {
    name                = "environment-headers"
    resource_group_name = azurerm_resource_group.main.name
    application_gateway_name = azurerm_application_gateway.main.name

    rewrite_rule {
      name = "add-environment-headers"
      rule_sequence = 100

      response_header_configuration {
        header_name  = "X-Environment"
        header_value = var.environment_name
      }

      response_header_configuration {
        header_name  = "X-Environment-Color"
        header_value = local.environment_colors[var.environment_name]
      }

      response_header_configuration {
        header_name  = "X-Environment-Region"
        header_value = var.azure_region
      }

      response_header_configuration {
        header_name  = "X-Deployment-Version"
        header_value = var.deployment_version
      }

      response_header_configuration {
        header_name  = "X-Deployment-Date"
        header_value = timestamp()
      }
    }
  }

  locals {
    environment_colors = {
      "dev"     = "green"
      "test"    = "yellow"
      "staging" = "orange"
      "prod"    = "red"
    }
  }
  ```
- [ ] Configure per-environment variables
- [ ] Test header injection locally

### Task 3: Application Gateway Configuration
- [ ] Update Application Gateway backend settings
  ```hcl
  # terraform/application-gateway.tf addition
  resource "azurerm_application_gateway" "main" {
    # ... existing configuration ...

    rewrite_rule_set {
      id = azurerm_application_gateway_rewrite_rule_set.environment_headers.id
    }

    request_routing_rule {
      name                       = "environment-routing"
      rule_type                  = "Basic"
      http_listener_id           = azurerm_application_gateway_http_listener.main.id
      backend_address_pool_id    = azurerm_application_gateway_backend_address_pool.main.id
      backend_http_settings_id   = azurerm_application_gateway_backend_http_settings.main.id
      rewrite_rule_set_id       = azurerm_application_gateway_rewrite_rule_set.environment_headers.id
    }
  }
  ```
- [ ] Configure health probe headers
- [ ] Setup custom error pages with headers

### Task 4: Environment-Specific Configuration
- [ ] Create environment variable mappings
  ```yaml
  # environments/dev.tfvars
  environment_name = "dev"
  deployment_version = "1.0.0-dev"
  azure_region = "eastus"
  enable_debug_headers = true

  # environments/test.tfvars
  environment_name = "test"
  deployment_version = "1.0.0-test"
  azure_region = "eastus"
  enable_debug_headers = true

  # environments/staging.tfvars
  environment_name = "staging"
  deployment_version = "1.0.0-rc"
  azure_region = "eastus"
  enable_debug_headers = true

  # environments/prod.tfvars
  environment_name = "prod"
  deployment_version = "1.0.0"
  azure_region = "eastus"
  enable_debug_headers = false
  ```
- [ ] Configure production header minimization
- [ ] Setup header monitoring

### Task 5: Browser Testing
- [ ] Test headers in Chrome DevTools
  ```javascript
  // test-headers.js
  async function testEnvironmentHeaders() {
    const response = await fetch('/api/health');
    const headers = {};
    
    response.headers.forEach((value, key) => {
      if (key.startsWith('X-Environment')) {
        headers[key] = value;
      }
    });
    
    console.log('Environment Headers:', headers);
    
    // Validate headers
    assert(headers['X-Environment'], 'X-Environment header missing');
    assert(headers['X-Environment-Color'], 'X-Environment-Color header missing');
    assert(headers['X-Environment-Region'], 'X-Environment-Region header missing');
    assert(headers['X-Deployment-Version'], 'X-Deployment-Version header missing');
  }
  ```
- [ ] Test headers in Firefox
- [ ] Test headers in Edge
- [ ] Test headers in Safari
- [ ] Document browser compatibility

### Task 6: API Response Headers
- [ ] Configure API gateway headers
  ```python
  # middleware/environment_headers.py
  class EnvironmentHeaderMiddleware:
      def __init__(self, app):
          self.app = app
          
      def __call__(self, environ, start_response):
          def add_headers(status, headers):
              # Only add if not already present (WAF takes precedence)
              env_headers = [
                  ('X-Environment', os.getenv('ENVIRONMENT', 'unknown')),
                  ('X-Environment-Color', self.get_color()),
                  ('X-Environment-Region', os.getenv('AZURE_REGION', 'unknown')),
                  ('X-Deployment-Version', os.getenv('VERSION', 'unknown'))
              ]
              
              for header, value in env_headers:
                  if not any(h[0] == header for h in headers):
                      headers.append((header, value))
              
              return start_response(status, headers)
          
          return self.app(environ, add_headers)
      
      def get_color(self):
          colors = {
              'dev': 'green',
              'test': 'yellow',
              'staging': 'orange',
              'prod': 'red'
          }
          return colors.get(os.getenv('ENVIRONMENT', ''), 'gray')
  ```
- [ ] Test API endpoints
- [ ] Verify header consistency
- [ ] Document API header usage

### Task 7: Security Considerations
- [ ] Implement production header filtering
  ```hcl
  # Production-specific header filtering
  dynamic "response_header_configuration" {
    for_each = var.enable_debug_headers ? ["enabled"] : []
    content {
      header_name  = "X-Debug-Info"
      header_value = local.debug_info
    }
  }
  ```
- [ ] Configure CSP headers
- [ ] Test against header injection attacks
- [ ] Document security implications

### Task 8: Monitoring and Alerts
- [ ] Setup header monitoring
  ```yaml
  # prometheus-rules.yml addition
  - alert: MissingEnvironmentHeaders
    expr: |
      rate(http_requests_without_env_header_total[5m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Missing environment headers detected"
      description: "{{ $value }} requests/sec without X-Environment header"
  ```
- [ ] Create Grafana dashboard for header metrics
- [ ] Setup alerts for header anomalies
- [ ] Document monitoring procedures

---

## Dev Notes

### Header Format
```
X-Environment: dev|test|staging|prod
X-Environment-Color: green|yellow|orange|red
X-Environment-Region: eastus|westus|northeurope
X-Deployment-Version: 1.0.0-[sha]
X-Deployment-Date: 2025-09-22T12:00:00Z
```

### WAF Rule Priority
1. Security headers (HSTS, CSP, etc.)
2. Environment headers
3. Caching headers
4. Custom application headers

### Testing Commands
```bash
# Test header injection
curl -I https://app-dev.oversight.com | grep X-Environment

# Test with different tools
wget --server-response https://app-dev.oversight.com 2>&1 | grep X-Environment

# Test API endpoint
curl -H "Accept: application/json" https://api-dev.oversight.com/health -I
```

### Browser Console Testing
```javascript
// Quick test in browser console
fetch('/').then(r => {
  console.log('Environment:', r.headers.get('X-Environment'));
  console.log('Color:', r.headers.get('X-Environment-Color'));
  console.log('Region:', r.headers.get('X-Environment-Region'));
  console.log('Version:', r.headers.get('X-Deployment-Version'));
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Assistant |

---

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
**Expected files to be created/modified:**
- `/terraform/waf-policy.tf`
- `/terraform/application-gateway.tf`
- `/terraform/environments/*.tfvars`
- `/tests/environment/header_injection_test.py`
- `/scripts/test-headers.sh`
- `/docs/environment-headers.md`

---

## QA Results
_To be populated by QA agent_