# Story 7.2: Infrastructure-Managed UI Banner

**Epic:** 7 - Environment Visibility  
**Story Number:** 7.2  
**Title:** Inject Visible Environment Banner via WAF/Application Gateway  
**Status:** PLANNED  
**Points:** 5  
**Component:** 1102 (UI Banner Injection)  

---

## Story

**As a** Developer/Administrator,  
**I want** a visible environment banner automatically injected at the top of every web page,  
**so that** I can immediately see which environment I'm working in without checking developer tools.

---

## Acceptance Criteria

1. Banner automatically injected at top of all HTML pages via WAF/Application Gateway
2. Banner shows environment name prominently (DEV, TEST, STAGING, PROD)
3. Banner has environment-specific color coding (green/yellow/orange/red)
4. Banner stays fixed at top of page during scrolling
5. Banner doesn't interfere with application functionality
6. Banner injection works without modifying application code
7. Production banner can be disabled or minimized via configuration
8. Banner includes deployment version and region information

---

## Tasks / Subtasks

### Task 1: Write Tests for Banner Injection (TDD)
- [ ] Create `tests/environment/banner_injection_test.py`
  - [ ] Test banner HTML injection in responses
  - [ ] Test banner appears on all HTML pages
  - [ ] Test banner styling matches environment
  - [ ] Test banner doesn't break JavaScript
  - [ ] Test banner position and visibility
- [ ] Run tests to confirm they fail (Red phase)

### Task 2: Implement WAF HTML Injection Rules
- [ ] Configure WAF to inject banner HTML
  ```hcl
  # terraform/waf-banner-injection.tf
  resource "azurerm_application_gateway_rewrite_rule_set" "environment_banner" {
    name                = "environment-banner-injection"
    resource_group_name = azurerm_resource_group.main.name
    application_gateway_name = azurerm_application_gateway.main.name

    rewrite_rule {
      name = "inject-environment-banner"
      rule_sequence = 50

      condition {
        variable = "http_resp_Content-Type"
        pattern  = "text/html"
        ignore_case = true
        negate = false
      }

      response_header_configuration {
        header_name  = "Content-Security-Policy"
        header_value = "default-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
      }

      # URL rewrite to modify response body
      url {
        path = "/*"
        components = "path_only"
      }

      # Response body modification
      response_body {
        search  = "</body>"
        replace = local.banner_html
      }
    }
  }

  locals {
    banner_html = <<-EOT
      <script>
        (function() {
          if (document.getElementById('infra-env-banner')) return;
          
          var banner = document.createElement('div');
          banner.id = 'infra-env-banner';
          banner.innerHTML = '${local.banner_content}';
          
          var style = document.createElement('style');
          style.textContent = '${local.banner_css}';
          
          document.head.appendChild(style);
          document.body.insertBefore(banner, document.body.firstChild);
          document.body.style.paddingTop = '40px';
        })();
      </script>
      </body>
    EOT

    banner_content = <<-EOT
      <div class="env-banner-content">
        <span class="env-name">${upper(var.environment_name)} ENVIRONMENT</span>
        <span class="env-info">
          <span class="env-version">v${var.deployment_version}</span>
          <span class="env-region">${var.azure_region}</span>
        </span>
      </div>
    EOT

    banner_css = <<-EOT
      #infra-env-banner {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: ${local.environment_colors[var.environment_name]};
        color: white;
        z-index: 999999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        opacity: ${var.environment_name == "prod" ? "0.8" : "1"};
      }
      
      #infra-env-banner .env-banner-content {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      
      #infra-env-banner .env-name {
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      #infra-env-banner .env-info {
        display: flex;
        gap: 15px;
        font-size: 12px;
        opacity: 0.9;
      }
      
      #infra-env-banner .env-version::before {
        content: 'Version: ';
        opacity: 0.7;
      }
      
      #infra-env-banner .env-region::before {
        content: 'Region: ';
        opacity: 0.7;
      }
      
      body.has-env-banner {
        padding-top: 40px !important;
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        #infra-env-banner .env-info {
          display: none;
        }
      }
    EOT

    environment_colors = {
      "dev"     = "linear-gradient(90deg, #10b981 0%, #059669 100%)"  # Green
      "test"    = "linear-gradient(90deg, #eab308 0%, #ca8a04 100%)"  # Yellow
      "staging" = "linear-gradient(90deg, #f97316 0%, #ea580c 100%)"  # Orange
      "prod"    = "linear-gradient(90deg, #ef4444 0%, #dc2626 100%)"  # Red
    }
  }
  ```
- [ ] Test HTML modification rules
- [ ] Validate banner injection

### Task 3: Alternative Approach - Edge Function Injection
- [ ] Implement Azure Front Door Rules Engine
  ```hcl
  # terraform/front-door-banner.tf
  resource "azurerm_frontdoor_rules_engine" "banner_injection" {
    name                = "banner-injection-rules"
    frontdoor_name      = azurerm_frontdoor.main.name
    resource_group_name = azurerm_resource_group.main.name

    rule {
      name     = "inject-environment-banner"
      priority = 1

      match_condition {
        variable = "RequestHeader"
        selector = "Content-Type"
        operator = "Contains"
        value    = ["text/html"]
      }

      action {
        response_header_action {
          header_action = "Append"
          header_name   = "X-Environment-Banner"
          value        = "enabled"
        }

        route_configuration_override_action {
          cache_configuration {
            cache_behavior = "BypassCache"
          }
        }
      }
    }
  }
  ```
- [ ] Configure edge function for HTML modification
- [ ] Test edge-based injection

### Task 4: Application Gateway Advanced Rewrite
- [ ] Configure response body rewriting
  ```powershell
  # PowerShell script for Application Gateway configuration
  $appGw = Get-AzApplicationGateway -Name "agw-oversight-${env}" -ResourceGroupName $rgName
  
  $rewriteRule = New-AzApplicationGatewayRewriteRule `
    -Name "InjectEnvironmentBanner" `
    -RuleSequence 100 `
    -ResponseHeaderConfiguration @{
      HeaderName = "Cache-Control"
      HeaderValue = "no-cache, no-store, must-revalidate"
    }
  
  # Configure URL rewrite with response body modification
  $rewriteRuleSet = New-AzApplicationGatewayRewriteRuleSet `
    -Name "EnvironmentBannerRuleSet" `
    -RewriteRule $rewriteRule
  
  $appGw.RewriteRuleSets.Add($rewriteRuleSet)
  Set-AzApplicationGateway -ApplicationGateway $appGw
  ```
- [ ] Test response modification
- [ ] Validate performance impact

### Task 5: Nginx Ingress Controller Option (Kubernetes)
- [ ] Configure Nginx ingress for banner injection
  ```yaml
  # kubernetes/nginx-banner-configmap.yaml
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: nginx-banner-injection
    namespace: ingress-nginx
  data:
    banner-injection.js: |
      function injectBanner(r) {
        var env = r.variables.environment || 'unknown';
        var version = r.variables.app_version || 'unknown';
        var region = r.variables.region || 'unknown';
        
        var colors = {
          'dev': '#10b981',
          'test': '#eab308',
          'staging': '#f97316',
          'prod': '#ef4444'
        };
        
        var banner = `
          <div id="infra-env-banner" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: ${colors[env] || '#6b7280'};
            color: white;
            z-index: 999999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: sans-serif;
            font-size: 14px;
            font-weight: bold;
          ">
            <span>${env.toUpperCase()} ENVIRONMENT</span>
            <span style="margin-left: 20px; font-size: 12px;">v${version} | ${region}</span>
          </div>
          <style>body { padding-top: 40px !important; }</style>
        `;
        
        return banner;
      }
  ---
  apiVersion: networking.k8s.io/v1
  kind: Ingress
  metadata:
    name: app-ingress
    annotations:
      nginx.ingress.kubernetes.io/configuration-snippet: |
        sub_filter '</body>' '<script>
          (function() {
            if (!document.getElementById("infra-env-banner")) {
              var banner = document.createElement("div");
              banner.id = "infra-env-banner";
              banner.style.cssText = "position:fixed;top:0;left:0;right:0;height:40px;background:${BANNER_COLOR};color:white;z-index:999999;display:flex;align-items:center;justify-content:center;font-family:sans-serif;font-size:14px;font-weight:bold;";
              banner.innerHTML = "<span>${ENVIRONMENT} ENVIRONMENT</span>";
              document.body.insertBefore(banner, document.body.firstChild);
              document.body.style.paddingTop = "40px";
            }
          })();
        </script></body>';
        sub_filter_once off;
        sub_filter_types text/html;
  ```
- [ ] Deploy Nginx configuration
- [ ] Test ingress-based injection

### Task 6: CDN-Level Injection (Azure CDN)
- [ ] Configure Azure CDN Rules Engine
  ```hcl
  # terraform/cdn-banner-injection.tf
  resource "azurerm_cdn_endpoint_delivery_rule" "banner_injection" {
    name            = "InjectEnvironmentBanner"
    cdn_endpoint_id = azurerm_cdn_endpoint.main.id
    order          = 1

    conditions {
      request_header_condition {
        selector         = "Content-Type"
        operator        = "Contains"
        match_values    = ["text/html"]
        negate_condition = false
      }
    }

    modify_response_header_action {
      action = "Append"
      name   = "X-Banner-Injection"
      value  = "enabled"
    }

    # Note: CDN doesn't support body modification directly
    # Would need to use Azure Functions or Logic Apps for this
  }
  ```
- [ ] Implement Azure Function for body modification
- [ ] Test CDN-based approach

### Task 7: Testing and Validation
- [ ] Create automated tests
  ```python
  # tests/environment/test_banner_injection.py
  import requests
  from bs4 import BeautifulSoup
  import pytest

  class TestEnvironmentBanner:
      
      @pytest.mark.parametrize("env,color", [
          ("dev", "rgb(16, 185, 129)"),
          ("test", "rgb(234, 179, 8)"),
          ("staging", "rgb(249, 115, 22)"),
          ("prod", "rgb(239, 68, 68)")
      ])
      def test_banner_injection(self, env, color):
          """Test that banner is injected with correct styling"""
          response = requests.get(f"https://app-{env}.oversight.com")
          soup = BeautifulSoup(response.text, 'html.parser')
          
          # Check banner exists
          banner = soup.find(id='infra-env-banner')
          assert banner is not None, "Environment banner not found"
          
          # Check environment name
          assert env.upper() in banner.text
          
          # Check color in style
          style = banner.get('style', '')
          assert color in style or f"background: {color}" in style
          
      def test_banner_fixed_position(self):
          """Test that banner stays at top of page"""
          response = requests.get("https://app-dev.oversight.com")
          soup = BeautifulSoup(response.text, 'html.parser')
          
          banner = soup.find(id='infra-env-banner')
          style = banner.get('style', '')
          
          assert 'position: fixed' in style or 'position:fixed' in style
          assert 'top: 0' in style or 'top:0' in style
          
      def test_body_padding(self):
          """Test that body has padding to accommodate banner"""
          response = requests.get("https://app-dev.oversight.com")
          
          # Check for padding-top style
          assert 'padding-top: 40px' in response.text or 'padding-top:40px' in response.text
          
      def test_banner_not_in_api_responses(self):
          """Test that banner is NOT injected in API responses"""
          response = requests.get("https://api-dev.oversight.com/health",
                                 headers={'Accept': 'application/json'})
          
          assert 'infra-env-banner' not in response.text
  ```
- [ ] Manual browser testing
- [ ] Performance impact testing
- [ ] Cross-browser compatibility

### Task 8: Production Configuration
- [ ] Configure production banner behavior
  ```hcl
  # terraform/variables.tf
  variable "banner_configuration" {
    type = object({
      enabled = bool
      opacity = number
      auto_hide = bool
      hide_after_seconds = number
      minimized = bool
    })
    default = {
      enabled = true
      opacity = 1.0
      auto_hide = false
      hide_after_seconds = 0
      minimized = false
    }
  }

  # Production override
  # environments/prod.tfvars
  banner_configuration = {
    enabled = true
    opacity = 0.3
    auto_hide = true
    hide_after_seconds = 10
    minimized = true
  }
  ```
- [ ] Implement auto-hide functionality
- [ ] Test production configuration

---

## Dev Notes

### Banner Specifications
```css
/* Banner Dimensions */
Height: 40px (fixed)
Width: 100% (full width)
Position: Fixed top
Z-index: 999999 (above all content)

/* Color Scheme */
Dev: Green (#10b981)
Test: Yellow (#eab308)  
Staging: Orange (#f97316)
Prod: Red (#ef4444)

/* Typography */
Font: System font stack
Size: 14-16px
Weight: 600-700
Text: Uppercase for environment name
```

### Implementation Priority
1. **Application Gateway/WAF** - If response body modification supported
2. **Nginx Ingress** - For Kubernetes deployments
3. **Edge Functions** - For CDN/Front Door deployments
4. **Client-side JavaScript** - Fallback option

### Performance Considerations
- Banner injection should add < 10ms latency
- Use CSS-only styling (no external resources)
- Minimize JavaScript execution
- Cache banner HTML where possible

### Testing URLs
```bash
# Dev environment
https://app-dev.oversight.com

# Test environment  
https://app-test.oversight.com

# Staging environment
https://app-staging.oversight.com

# Production (minimal banner)
https://app.oversight.com
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story creation | Assistant |

---

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
**Expected files to be created/modified:**
- `/terraform/waf-banner-injection.tf`
- `/terraform/front-door-banner.tf` (if using Front Door)
- `/kubernetes/nginx-banner-configmap.yaml` (if using k8s)
- `/tests/environment/test_banner_injection.py`
- `/scripts/test-banner.sh`
- `/docs/environment-banner-guide.md`

---

## QA Results
_To be populated by QA agent_